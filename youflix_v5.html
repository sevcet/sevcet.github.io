<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouFlix Player</title>

<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }

    #player {
        width: 100%;
        height: 100%;
        position: absolute;
        top:0;
        left:0;
    }

    #loading {
        position:absolute;
        top:0;left:0;
        width:100%;height:100%;
        background:black;
        z-index:9999;
        display:flex;
        align-items:center;
        justify-content:center;
        flex-direction:column;
        color:white;
    }

    #toast {
        position:absolute;
        top:40px;
        left:50%;
        transform:translateX(-50%);
        background:rgba(20,20,20,0.85);
        color:white;
        padding:12px 25px;
        border-radius:12px;
        opacity:0;
        font-size:18px;
        transition:opacity .4s;
        z-index:99999;
    }
</style>

</head>

<body>

<div id="loading">
    <div style="border:5px solid #444;border-top:5px solid red;width:50px;height:50px;border-radius:50%;animation:spin 1s linear infinite;"></div>
    <div style="margin-top:20px;font-size:18px;">Učitavam video...</div>
</div>

<div id="toast"></div>
<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   PRIMAMO PODATKE IZ ANDROID-A
============================================================ */
const params = new URLSearchParams(window.location.search);
const VIDEO_ID = params.get("videoId");
const USER_LANG = (params.get("lang") || "en").toLowerCase();

/* ============================================================
   SRODNI JEZICI (FALLBACK ZA AUTOPICK)
============================================================ */
const RELATED = {
    /* Ex-YU */
    "sr": ["bs","hr"],
    "bs": ["sr","hr"],
    "hr": ["sr","bs"],

    /* Central Slavic */
    "sk": ["cs"],
    "cs": ["sk"],
    "sl": ["hr","sr"],
    "pl": ["cs","sk"],

    /* Scandinavian */
    "da": ["sv","no"],
    "sv": ["da","no","is"],
    "no": ["sv","da"],
    "is": ["sv"],

    /* Balkan East */
    "mk": ["bg","sr"],
    "bg": ["mk","sr"],

    /* East Europe */
    "uk": ["ru"],
    "ru": ["uk"],

    /* Romance */
    "fr": ["es","it","pt"],
    "es": ["fr","pt","it"],
    "pt": ["es","fr","it"],
    "it": ["es","fr","pt"],

    /* East Asian */
    "zh": ["ja","ko"],
    "ja": ["zh","ko"],
    "ko": ["zh","ja"]
};


/* ============================================================
   AUTOMATSKI IZBOR TITLA — originalna logika
============================================================ */
function pickSub(available, lang) {

    // 1) direktno
    if (available.includes(lang)) return lang;

    // 2) srodni jezik
    if (RELATED[lang]) {
        for (let r of RELATED[lang]) {
            if (available.includes(r)) return r;
        }
    }

    // 3) auto translate EN -> sistemski
    if (available.includes("en")) return "auto-en";

    return null;
}

/* ============================================================
   YOUTUBE PLAYER
============================================================ */
let player = null;

function onYouTubeIframeAPIReady() {

    player = new YT.Player("player", {
        videoId: VIDEO_ID,
        width:"100%",
        height:"100%",
        playerVars:{
            autoplay:1,
            controls:1,
            cc_load_policy:1,
            iv_load_policy:3,
            rel:0,
            fs:1,
            hl:USER_LANG
        },
        events:{
            onReady:onReady
        }
    });
}

/* ============================================================
   READY → AUTOMATSKI TITLOVI
============================================================ */
function onReady() {
    setTimeout(() => {

        let tracks = [];
        try { tracks = player.getOption("captions","tracklist") || []; }
        catch(e){}

        const available = tracks.map(t => t.languageCode.toLowerCase());
        const chosen = pickSub(available, USER_LANG);

        if (!chosen) {
            toast("Nema titlova");
        }
        else if (chosen === "auto-en") {
            player.setOption("captions","track",{languageCode:"en"});
            player.setOption("captions","translate", USER_LANG);
            toast("Auto prevod → " + USER_LANG.toUpperCase());
        }
        else {
            player.setOption("captions","track",{languageCode:chosen});
            toast("Titl: " + chosen.toUpperCase());
        }

        document.getElementById("loading").style.display = "none";

    }, 900);
}

/* ============================================================
   DPAD — originalno + stabilno
============================================================ */
document.addEventListener("keydown", e => {

    switch(e.key) {

        case "ArrowLeft":
            player.seekTo(Math.max(0, player.getCurrentTime() - 20), true);
            e.preventDefault();
            break;

        case "ArrowRight":
            player.seekTo(player.getCurrentTime() + 20, true);
            e.preventDefault();
            break;

        case "Enter":
            let s = player.getPlayerState();
            if (s === 1) player.pauseVideo();
            else player.playVideo();
            e.preventDefault();
            break;

        case "ArrowDown":
            player.getIframe().contentWindow.postMessage(
                JSON.stringify({event:"command",func:"showControls",args:[true]}),"*"
            );
            e.preventDefault();
            break;

        case "ArrowUp":
            // otvara YouTube CC meni
            player.getIframe().contentWindow.postMessage(
                JSON.stringify({event:"command",func:"showControls",args:[true]}),"*"
            );
            e.preventDefault();
            break;
    }
});

/* ============================================================
   TOAST
============================================================ */
let toastTimer=null;
function toast(msg){
    const t=document.getElementById("toast");
    t.innerHTML=msg;
    t.style.opacity=1;
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>t.style.opacity=0,2500);
}
</script>

</body>
</html>
