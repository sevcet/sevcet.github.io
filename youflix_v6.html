<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouFlix Player v53 (Stable)</title>

<style>
body, html {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
}

/* Loading */
#loadingScreen {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 9999;
}

.spinner {
    width: 55px;
    height: 55px;
    border: 5px solid #333;
    border-top: 5px solid #ff4444;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Player container */
#playerContainer {
    width: 100%;
    height: 100%;
    position: relative;
}

/* Progress bar */
#progressContainer {
    position: absolute;
    bottom: 55px;
    left: 5%;
    width: 90%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,0.2);
    opacity: 0;
    transition: opacity 0.3s ease;
}
#progressBar {
    width: 0%;
    height: 100%;
    background: #ff4444;
    border-radius: 3px;
}

/* Seek indicators */
.seek-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.7);
    padding: 12px 16px;
    border-radius: 8px;
    color: white;
    opacity: 0;
    transition: opacity .3s;
}
#seekBackward { left: 35px; }
#seekForward { right: 35px; }

/* CC menu */
#ccMenu {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 420px;
    max-height: 520px;

    background: rgba(0,0,0,0.95);
    color: white;

    border-radius: 12px;
    padding: 20px;
    z-index: 10020;

    opacity: 0;
    transition: opacity .3s ease;
    pointer-events: none;

    display: flex;
    flex-direction: column;
}

#ccMenu.visible {
    opacity: 1;
    pointer-events: auto;
}

.menu-title {
    font-size: 22px;
    margin-bottom: 12px;
    text-align: center;
    color: #ff4444;
}

.cc-options-container {
    flex: 1;
    overflow-y: auto;
    max-height: 420px;
    padding-right: 10px;
    scrollbar-width: thin;
}

.cc-option {
    padding: 12px 16px;
    margin-bottom: 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
}

.cc-option.selected {
    background: rgba(255,68,68,0.25);
    border-color: #ff4444;
}

.scroll-indicator {
    text-align: center;
    font-size: 12px;
    margin-top: 12px;
    color: #777;
}
</style>
</head>

<body>

<!-- Loading -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <div style="margin-top:15px;font-size:18px;">Loading player...</div>
</div>

<!-- Player -->
<div id="playerContainer">
    <div id="player"></div>
</div>

<!-- Progress -->
<div id="progressContainer"><div id="progressBar"></div></div>

<!-- Seek indicators -->
<div id="seekBackward" class="seek-indicator">⏪ -60s</div>
<div id="seekForward" class="seek-indicator">+60s ⏩</div>

<!-- CC Menu -->
<div id="ccMenu">
    <div class="menu-title">Subtitles</div>
    <div id="ccOptions" class="cc-options-container"></div>
    <div class="scroll-indicator">↑↓ navigate • ENTER select • BACK exit</div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let isPlaying = false;
let progressTimer;
let currentCCSelection = 0;
let isCCMenuOpen = false;

let availableTracks = [];

function getUrlParam(key){
    const p = new URLSearchParams(window.location.search);
    return p.get(key);
}

const videoId = getUrlParam("videoId");
const autoLang = getUrlParam("lang") || "en";

function onYouTubeIframeAPIReady(){
    if (!videoId) return;

    player = new YT.Player("player", {
        width:"100%", height:"100%",
        videoId: videoId,
        playerVars:{
            autoplay:1,
            controls:0,
            rel:0,
            modestbranding:1,
            fs:1,
            iv_load_policy:3,
            playsinline:1,
            disablekb:1,
            cc_load_policy:1  /* CC modul mora biti učitan! */
        },
        events:{
            onReady:onPlayerReady,
            onStateChange:onPlayerStateChange
        }
    });
}

function onPlayerReady(){
    document.getElementById("loadingScreen").style.display="none";

    setTimeout(() => {
        buildTrackList();
        autoSelectOrTranslate(autoLang);
    }, 1100);

    startProgress();
}

function onPlayerStateChange(e){
    if (e.data === YT.PlayerState.PLAYING){
        isPlaying = true;
    }
    if (e.data === YT.PlayerState.PAUSED){
        isPlaying = false;
    }
}

function startProgress() {
    progressTimer = setInterval(() => {
        if (!player || !player.getDuration) return;
        const ct = player.getCurrentTime();
        const d = player.getDuration();
        document.getElementById("progressBar").style.width =
            ((ct / d) * 100) + "%";
    }, 900);
}

/* ================================
   CAPTION TRACK DETECTION
   ================================ */

function buildTrackList() {
    const opts = document.getElementById("ccOptions");
    opts.innerHTML = "";

    availableTracks = player.getOption("captions", "tracklist") || [];

    availableTracks.forEach((t, idx) => {
        const div = document.createElement("div");
        div.className = "cc-option";
        div.textContent = t.languageCode.toUpperCase() + (t.kind === "asr" ? " (ASR)" : "");
        div.dataset.index = idx;
        opts.appendChild(div);
    });
}

/* ====================================
   AUTO SELECT + AUTO TRANSLATE ENGINE
   ==================================== */

async function autoSelectOrTranslate(lang){
    const tracks = availableTracks;
    if (!tracks || tracks.length === 0) return;

    /* 1) EXACT MATCH */
    const exact = tracks.find(t => t.languageCode === lang && t.kind === "standard");
    if (exact){
        setTrack(exact);
        return;
    }

    /* 2) ASR MATCH */
    const asr = tracks.find(t => t.languageCode === lang && t.kind === "asr");
    if (asr){
        setTrack(asr);
        return;
    }

    /* 3) FALLBACK PRIORITY */
    const chain = {
        mk: ["bg","sr","en"],
        sq: ["mk","bg","en"],
        bg: ["sr","en"],
        ja: ["zh","en"],
        ko: ["zh","en"],
        vi: ["zh","en"]
    }[lang] || ["en"];

    for (let f of chain){
        const fallbackTrack = tracks.find(t => t.languageCode === f);
        if (fallbackTrack){
            setTrack(fallbackTrack);
            return;
        }
    }

    /* 4) AUTO TRANSLATE (CORE) */
    let base = tracks.find(t => t.languageCode === "en");
    if (!base) base = tracks[0];

    setTrack(base);

    /* YouTube CC loader delay */
    await new Promise(r => setTimeout(r, 450));

    /* STABILNI TRANSLATE → sigurno radi */
    setTimeout(() => {
        try {
            console.log("AUTO-TRANSLATE → " + lang);
            player.setOption("captions","translate", lang);
        } catch(e){}
    }, 1500);
}

function setTrack(track){
    player.setOption("captions","track", track);
}

/* ===========================
   CC MENU DPAD HANDLING
   =========================== */

document.addEventListener("keydown", function(e){

    if (e.key === "ArrowUp"){
        if (!isCCMenuOpen) openCCMenu();
        else moveCC(-1);
        e.preventDefault();
    }

    if (e.key === "ArrowDown"){
        if (isCCMenuOpen) moveCC(1);
        e.preventDefault();
    }

    if (e.key === "Enter"){
        if (isCCMenuOpen){
            selectCC();
        } else {
            togglePlayPause();
        }
        e.preventDefault();
    }

    if (e.key === "ArrowLeft"){
        seek(-1);
        e.preventDefault();
    }

    if (e.key === "ArrowRight"){
        seek(1);
        e.preventDefault();
    }

    if (e.key === "Backspace" || e.key === "Escape"){
        if (isCCMenuOpen){
            closeCCMenu();
        } else {
            if (window.AndroidInterface) AndroidInterface.closePlayer();
            else history.back();
        }
        e.preventDefault();
    }
});

/* CC MENU CONTROLS */

function openCCMenu(){
    isCCMenuOpen = true;
    document.getElementById("ccMenu").classList.add("visible");
    currentCCSelection = 0;
    highlightCC();
}
function closeCCMenu(){
    isCCMenuOpen = false;
    document.getElementById("ccMenu").classList.remove("visible");
}

function highlightCC(){
    const items = document.querySelectorAll(".cc-option");
    items.forEach(i => i.classList.remove("selected"));
    if (items[currentCCSelection])
        items[currentCCSelection].classList.add("selected");

    items[currentCCSelection].scrollIntoView({block:"center"});
}

function moveCC(d){
    const items = document.querySelectorAll(".cc-option");
    currentCCSelection += d;
    if (currentCCSelection < 0) currentCCSelection = items.length - 1;
    if (currentCCSelection >= items.length) currentCCSelection = 0;
    highlightCC();
}

function selectCC(){
    const items = document.querySelectorAll(".cc-option");
    const idx = items[currentCCSelection].dataset.index;
    const lang = availableTracks[idx].languageCode;

    autoSelectOrTranslate(lang);
    closeCCMenu();
}

/* SEEK */
function seek(d){
    const t = player.getCurrentTime();
    player.seekTo(t + d * 60, true);
}

/* PLAY/PAUSE */
function togglePlayPause(){
    if (isPlaying) player.pauseVideo();
    else player.playVideo();
}
</script>

</body>
</html>
