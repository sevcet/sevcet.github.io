<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV YouTube Player</title>

<style>
body, html {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
}

#loadingScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
}
#loadingText {
    margin-top: 20px;
    font-size: 18px;
    text-align: center;
}
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #333;
    border-top: 5px solid #ff4444;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#customThumbnail {
    position: absolute;
    top: 0;
    left: 0;
    width: 0px;
    height: 0px;
    background: #000;
    z-index: 9998;
    display: none;
}

#errorScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    text-align: center;
    padding: 20px;
}
#retryButton {
    background: #ff4444;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
}

#playerContainer {
    width: 100%;
    height: 100%;
    position: relative;
}
#player {
    width: 100%;
    height: 100%;
    border: none;
}

#progressContainer {
    position: absolute;
    bottom: 60px;
    left: 5%;
    width: 90%;
    background: rgba(255,255,255,0.2);
    height: 6px;
    border-radius: 3px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#progressBar {
    height: 100%;
    background: #ff4444;
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

.seek-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 18px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#seekBackward { left: 30px; }
#seekForward { right: 30px; }
</style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Loading YouTube player...</div>
</div>

<div id="customThumbnail"></div>

<div id="errorScreen">
    <div id="errorText">Error loading YouTube player</div>
    <div>Check your internet connection</div>
    <button id="retryButton">TRY AGAIN</button>
</div>

<div id="playerContainer"></div>

<div id="progressContainer">
    <div id="progressBar"></div>
</div>

<div id="seekBackward" class="seek-indicator">⏪ -20s</div>
<div id="seekForward" class="seek-indicator">+20s ⏩</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let hideTimeout;
let isPlaying = false;
let progressInterval;
let customThumbnail;
let stateCheckInterval;
let hasAdStarted = false;
let hasVideoStarted = false;
let captionsSet = false;

const urlParams = new URLSearchParams(window.location.search);
const videoId  = urlParams.get("videoId");
const subLang  = urlParams.get("subLang")  || "auto";
const userLang = urlParams.get("userLang") || "en";

function onYouTubeIframeAPIReady() {
    initializePlayer();
}

function initializePlayer() {
    customThumbnail = document.getElementById('customThumbnail');

    if (!videoId) {
        showError("No Video ID in URL");
        return;
    }

    // Lazy load iframe
    const container = document.getElementById('playerContainer');
    const iframe = document.createElement('iframe');
    iframe.id = 'player';
    iframe.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1&rel=0&modestbranding=1&controls=0&fs=1&iv_load_policy=3&disablekb=1&playsinline=1&cc_load_policy=0&enablejsapi=1&hl=' + userLang;
    iframe.width = '100%';
    iframe.height = '100%';
    iframe.frameBorder = '0';
    container.appendChild(iframe);

    player = new YT.Player('player', {
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
        }
    });
}

function onPlayerReady() {
    document.getElementById('loadingScreen').style.display = 'none';
    hideControls();
    startAdDetection();
}

function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        startProgressTracking();
        checkIfAdOrVideo();

        if (!captionsSet && hasVideoStarted) {
            captionsSet = true;
            setTimeout(autoEnableCaptions, 1500);
        }
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        stopProgressTracking();
    } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        stopProgressTracking();
        hasVideoStarted = false;
        hasAdStarted = false;
        captionsSet = false;
    } else if (event.data === YT.PlayerState.BUFFERING) {
        setTimeout(checkBuffering, 2000);
    }

    resetHideTimer();
}

function checkIfAdOrVideo() {
    if (!player) return;
    const currentTime = player.getCurrentTime();
    if (currentTime === 0 && !hasVideoStarted) {
        hasAdStarted = true;
    } else {
        hasVideoStarted = true;
    }
}

function checkBuffering() {
    if (player && player.getPlayerState() === YT.PlayerState.BUFFERING) {
        // bez thumbnail-a
    }
}

function startAdDetection() {
    stateCheckInterval = setInterval(function() {
        if (player && player.getPlayerState && player.getCurrentTime) {
            const state = player.getPlayerState();
            const currentTime = player.getCurrentTime();
            if (state === YT.PlayerState.UNSTARTED) {}
            if (state === YT.PlayerState.ENDED) {}
        }
    }, 500);
}

function autoEnableCaptions() {
    if (!player) return;
    const targetFromApp = (subLang && subLang !== "auto") ? subLang : null;
    const lang = targetFromApp || mapLang(userLang);
    setCaptionTrack(lang);
}

function mapLang(lang) {
    if (!lang) return "en";
    const L = lang.toLowerCase();
    if (["sr","bs","hr","me"].includes(L)) return "sr";
    return L;
}

function setCaptionTrack(language) {
    if (!player) return;
    try {
        if (!language || language === "off") {
            player.setOption('captions', 'track', {});
            player.unloadModule('captions');
        } else {
            player.loadModule('captions');
            setTimeout(() => {
                player.setOption('captions', 'track', { languageCode: language });
                player.setOption('captions', 'reload', true);
            }, 300);
        }
    } catch (error) {
        console.log("setCaptionTrack error:", error);
    }
}

function onPlayerError(event) {
    showError("YouTube error: " + event.data);
}

function startProgressTracking() {
    stopProgressTracking();
    progressInterval = setInterval(updateProgress, 1000);
}
function stopProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}
function updateProgress() {
    if (player && player.getCurrentTime && player.getDuration) {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration() || 1;
        const progress = (currentTime / duration) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }
}

function seek(direction) {
    if (!player) return;
    const seekAmount = 20;
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration();
    const newTime = Math.max(0, Math.min(duration, currentTime + direction * seekAmount));
    player.seekTo(newTime, true);
}

function togglePlayPause() {
    if (!player) return;
    if (isPlaying) player.pauseVideo();
    else player.playVideo();
}

function showControls() {
    document.getElementById('progressContainer').style.opacity = '1';
}
function hideControls() {
    document.getElementById('progressContainer').style.opacity = '0';
    clearTimeout(hideTimeout);
}
function resetHideTimer() {
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(hideControls, 3000);
}

function showError(message) {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('errorScreen').style.display = 'flex';
    document.getElementById('errorText').textContent = message;
}
function retryPlayer() {
    document.getElementById('errorScreen').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'flex';
    captionsSet = false;
    initializePlayer();
}

document.addEventListener('keydown', function(event) {
    showControls();

    switch(event.key) {
        case 'Enter':
        case ' ':
            togglePlayPause();
            event.preventDefault();
            break;
        case 'ArrowLeft':
            seek(-1);
            event.preventDefault();
            break;
        case 'ArrowRight':
            seek(1);
            event.preventDefault();
            break;
        case 'Escape':
        case 'Backspace':
            if (window.AndroidInterface && typeof AndroidInterface.closePlayer === "function") {
                AndroidInterface.closePlayer();
            } else {
                window.history.back();
            }
            event.preventDefault();
            break;
    }
});

document.getElementById('retryButton').addEventListener('click', retryPlayer);

window.addEventListener('load', function() {
    setTimeout(hideControls, 2000);
});
window.addEventListener('beforeunload', function() {
    if (progressInterval) clearInterval(progressInterval);
});
</script>

</body>
</html>

