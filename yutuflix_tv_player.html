<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TV YouTube Player</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
}

/* player fullscreen, ništa preko njega */
#playerContainer {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000;
}
#player {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: none;
}
</style>
</head>
<body>

<div id="playerContainer">
    <div id="player"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;

const urlParams = new URLSearchParams(window.location.search);
const videoId  = urlParams.get("videoId");
const subLang  = urlParams.get("subLang")  || "auto";
const userLang = urlParams.get("userLang") || "en";

/* jednostavna mapa jezika – bez tracklist-a */
function mapLang(lang) {
    if (!lang) return "en";
    const L = lang.toLowerCase();
    if (["sr","bs","hr","me"].includes(L)) return "sr";
    return L;
}

function onYouTubeIframeAPIReady() {
    if (!videoId) return;

    player = new YT.Player("player", {
        height: "100%",
        width: "100%",
        videoId: videoId,
        playerVars: {
            autoplay: 1,
            rel: 0,
            modestbranding: 1,
            controls: 1,         // ostavi YouTube kontrole vidljive
            fs: 1,
            iv_load_policy: 3,
            disablekb: 1,        // naše DPAD komande
            playsinline: 1,
            cc_load_policy: 0,   // titlove palimo mi
            enablejsapi: 1,
            hl: userLang
        },
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
        }
    });
}

function onPlayerReady() {
    try { player.playVideo(); } catch(e){}
}

/* automatski titlovi kad video krene */
let captionsSet = false;
function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING && !captionsSet) {
        captionsSet = true;
        setTimeout(autoEnableCaptions, 1500);
    }
}

function autoEnableCaptions() {
    if (!player) return;

    const targetFromApp = (subLang && subLang !== "auto") ? subLang : null;
    const effUser = mapLang(userLang);

    if (targetFromApp) {
        setCaptionTrack(targetFromApp);
    } else {
        setCaptionTrack(effUser);
    }
}

/* minimalan pristup captions modu, bez tracklist-a i bez menija */
function setCaptionTrack(language) {
    if (!player) return;
    try {
        if (!language || language === "off") {
            player.setOption("captions", "track", {});
            player.unloadModule("captions");
        } else {
            player.loadModule("captions");
            setTimeout(() => {
                player.setOption("captions", "track", { languageCode: language });
                player.setOption("captions", "reload", true);
            }, 300);
        }
    } catch(e) {
        console.log("setCaptionTrack error", e);
    }
}

function onPlayerError(e) {
    console.log("YouTube error:", e.data);
}

/* DPAD: radimo play/pause i seek, ali ne crtamo ništa preko playera */
document.addEventListener("keydown", e => {
    if (!player) return;

    switch (e.key) {
        case "ArrowLeft": {
            const step = -60;
            const t = player.getCurrentTime();
            player.seekTo(Math.max(0, t + step), true);
            e.preventDefault();
            break;
        }
        case "ArrowRight": {
            const step = 60;
            const t = player.getCurrentTime();
            const d = player.getDuration() || 0;
            player.seekTo(Math.min(d, t + step), true);
            e.preventDefault();
            break;
        }
        case "Enter":
        case " ": {
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) player.pauseVideo();
            else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.ENDED) player.playVideo();
            e.preventDefault();
            break;
        }
        case "Escape":
        case "Backspace": {
            // BACK u WebView-u – Activity već hvata hardware BACK,
            // ovde samo za emulator / tastaturu
            if (window.AndroidInterface &&
                typeof AndroidInterface.closePlayer === "function") {
                AndroidInterface.closePlayer();
            } else {
                window.history.back();
            }
            e.preventDefault();
            break;
        }
    }
});
</script>
</body>
</html>
