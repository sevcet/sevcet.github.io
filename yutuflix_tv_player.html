<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TV YouTube Player</title>

<style>
/* (skraÄ‡eno â€“ isti stil kao kod tvog drugog playera) */
body, html {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
}
/* loading, thumbnail, error, progress, info, seek indikatori, ccMenu â€“ moÅ¾eÅ¡ uzeti direktno iz svog koda */
</style>
</head>
<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">UÄitavam YouTube player...</div>
</div>

<div id="customThumbnail">
    <div class="thumbnail-content">
        <div class="thumbnail-text">YU TU FLIX BALKAN<br>UÄitavam video...</div>
    </div>
</div>

<div id="errorScreen">
    <div id="errorText">GreÅ¡ka pri uÄitavanju YouTube playera</div>
    <div>Proverite internet konekciju</div>
    <button id="retryButton">POKUÅ AJ PONOVO</button>
</div>

<div id="playerContainer">
    <div id="player"></div>
</div>

<div id="progressContainer">
    <div id="progressBar"></div>
</div>

<div id="seekBackward" class="seek-indicator">âª -60s</div>
<div id="seekForward" class="seek-indicator">+60s â©</div>

<!-- CC MENU â€“ opciono; moÅ¾eÅ¡ ga izbaciti ako Å¾eliÅ¡ samo auto-titlove -->
<div id="ccMenu">
    <div class="menu-title">ğŸ¯ Odabir titlova</div>
    <div id="ccOptions" class="cc-options-container">
        <div class="cc-option selected" data-language="off">âŒ Bez titlova</div>
        <div class="cc-option" data-language="sr">ğŸ‡·ğŸ‡¸ Srpski</div>
        <div class="cc-option" data-language="en">ğŸ‡ºğŸ‡¸ Engleski</div>
        <div class="cc-option" data-language="hr">ğŸ‡­ğŸ‡· Hrvatski</div>
        <div class="cc-option" data-language="bs">ğŸ‡§ğŸ‡¦ Bosanski</div>
    </div>
    <div class="scroll-indicator">â†‘â†“ za navigaciju â€¢ ENTER za izbor</div>
</div>

<div id="infoPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;
let hideTimeout;
let isPlaying = false;
let isCCMenuOpen = false;
let currentCCSelection = 0;
let progressInterval;
let customThumbnail;
let stateCheckInterval;
let hasVideoStarted = false;

const urlParams = new URLSearchParams(window.location.search);
const videoId   = urlParams.get("videoId");
const subLang   = urlParams.get("subLang")  || "auto";
const userLang  = urlParams.get("userLang") || "en";   // jezik iz app-a

function onYouTubeIframeAPIReady() {
    initializePlayer();
}

function initializePlayer() {
    customThumbnail = document.getElementById("customThumbnail");

    if (!videoId) {
        showError("Nema Video ID-a u URL-u");
        return;
    }

    try {
        player = new YT.Player("player", {
            height: "100%",
            width: "100%",
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                rel: 0,
                modestbranding: 1,
                controls: 0,
                fs: 1,
                iv_load_policy: 3,
                disablekb: 1,
                playsinline: 1,
                cc_load_policy: 0,   // ne forsiramo CC dok mi ne odluÄimo
                enablejsapi: 1,
                hl: userLang
            },
            events: {
                onReady: onPlayerReady,
                onStateChange: onPlayerStateChange,
                onError: onPlayerError
            }
        });
    } catch (error) {
        showError("GreÅ¡ka pri pokretanju playera");
    }
}

function onPlayerReady() {
    document.getElementById("loadingScreen").style.display = "none";
    showCustomThumbnail();
    hideControls();
    startAdDetection();
    showInfo("â†â†’ Seek (60s) | â†‘ CC meni | ENTER Play/Pause | BACK Zatvori");

    // pokreni video
    try { player.playVideo(); } catch (e) {}
}

// --------- AUTOTITLOVI â€“ jednostavna logika ---------

function mapUserLangToEffectiveSimple(lang) {
    if (!lang) return "en";
    const L = lang.toLowerCase();

    // ex-YU
    if (["sr", "bs", "hr", "me"].includes(L)) return "sr";

    // slovenski
    if (["sl", "sk", "cs", "pl"].includes(L)) return L;

    // romanski
    if (["es","es-419","pt","pt-br","fr","it","ro"].includes(L)) return L;

    // germanski
    if (["de","nl","sv","no","da"].includes(L)) return L;

    // istoÄno-slovenski
    if (["ru","uk","bg"].includes(L)) return L;

    // fallback
    return "en";
}

function autoEnableCaptions() {
    if (!player || !player.getOption) return;

    try {
        // tanki wrapper: prvo pokuÅ¡aj subLang ako nije "auto".
        const targetFromApp = (subLang && subLang !== "auto") ? subLang : null;
        const effectiveUser = mapUserLangToEffectiveSimple(userLang);

        // prvo probaj subLang
        if (targetFromApp) {
            setCaptionTrack(targetFromApp, false);
            // ako ne uspe, UI Ä‡e i dalje raditi bez blokiranja
        } else {
            // nema subLang â†’ probaj userLang/effective
            setCaptionTrack(effectiveUser, false);
        }
    } catch(e) {
        console.log("autoEnableCaptions error:", e);
    }
}

// minimalni setCaptionTrack: ne dira tracklist, samo traÅ¾i da YouTube prikaÅ¾e dati jezik
function setCaptionTrack(language, closeMenuAfter) {
    if (!player) return;
    try {
        if (!language || language === "off") {
            player.setOption("captions", "track", {});
            player.unloadModule("captions");
        } else {
            player.loadModule("captions");
            setTimeout(() => {
                player.setOption("captions", "track", { languageCode: language });
                player.setOption("captions", "reload", true);
            }, 300);
        }
    } catch (error) {
        console.log("setCaptionTrack error:", error);
    }

    if (closeMenuAfter) hideCCMenu();
}

// --------- STANJE, PROGRESS, DPAD (kao tvoj drugi player) ---------

function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
        hideCustomThumbnail();
        isPlaying = true;
        startProgressTracking();

        if (!hasVideoStarted) {
            hasVideoStarted = true;
            // auto titl posle Å¡to se video stvarno pokrene
            setTimeout(autoEnableCaptions, 1500);
        }
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        stopProgressTracking();
    } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        stopProgressTracking();
        showCustomThumbnail();
        hasVideoStarted = false;
        showInfo("Video zavrÅ¡en");
    } else if (event.data === YT.PlayerState.BUFFERING) {
        setTimeout(checkBuffering, 2000);
    } else if (event.data === YT.PlayerState.UNSTARTED) {
        showCustomThumbnail();
    }
    resetHideTimer();
}

function onPlayerError(event) {
    showError("YouTube greÅ¡ka: " + event.data);
}

/* ostale funkcije: showCustomThumbnail, hideCustomThumbnail, startProgressTracking, updateProgress, startAdDetection, checkBuffering, stopAdDetection, showControls, hideControls, showInfo, showError, retryPlayer â€“ iste kao kod tvog drugog playera, moÅ¾eÅ¡ ih copy/paste */

function seek(direction) {
    if (isCCMenuOpen || !player) return;
    const seekAmount = 60;
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration();
    const newTime = Math.max(0, Math.min(duration, currentTime + (direction * seekAmount)));
    player.seekTo(newTime, true);
}

function togglePlayPause() {
    if (isCCMenuOpen) {
        selectCCOption();
        return;
    }
    if (!player) return;
    if (isPlaying) player.pauseVideo();
    else player.playVideo();
}

// CC meni (isti kao kod tebe, samo da koristi naÅ¡ setCaptionTrack)
function showCCMenu() {
    const menu = document.getElementById("ccMenu");
    menu.classList.add("visible");
    isCCMenuOpen = true;
    currentCCSelection = 0;
    updateCCSelection();
}

function hideCCMenu() {
    const menu = document.getElementById("ccMenu");
    menu.classList.remove("visible");
    isCCMenuOpen = false;
}

function updateCCSelection() {
    const options = document.querySelectorAll(".cc-option");
    options.forEach((option, index) => {
        if (index === currentCCSelection) option.classList.add("selected");
        else option.classList.remove("selected");
    });
}

function navigateCCMenu(direction) {
    if (!isCCMenuOpen) return;
    const options = document.querySelectorAll(".cc-option");
    currentCCSelection += direction;
    if (currentCCSelection < 0) currentCCSelection = options.length - 1;
    else if (currentCCSelection >= options.length) currentCCSelection = 0;
    updateCCSelection();
}

function selectCCOption() {
    if (!isCCMenuOpen || !player) return;
    const options = document.querySelectorAll(".cc-option");
    const selectedOption = options[currentCCSelection];
    const language = selectedOption.getAttribute("data-language");
    setCaptionTrack(language, true);
}

// DPAD
document.addEventListener("keydown", function(event) {
    showControlsTemporary();

    switch (event.key) {
        case "ArrowUp":
            if (!isCCMenuOpen) showCCMenu();
            else navigateCCMenu(-1);
            event.preventDefault();
            break;
        case "ArrowDown":
            if (isCCMenuOpen) navigateCCMenu(1);
            event.preventDefault();
            break;
        case "Enter":
            if (isCCMenuOpen) selectCCOption();
            else togglePlayPause();
            event.preventDefault();
            break;
        case " ":
            if (!isCCMenuOpen) togglePlayPause();
            event.preventDefault();
            break;
        case "ArrowLeft":
            seek(-1);
            event.preventDefault();
            break;
        case "ArrowRight":
            seek(1);
            event.preventDefault();
            break;
        case "Escape":
        case "Backspace":
            if (isCCMenuOpen) hideCCMenu();
            else closePlayer();
            event.preventDefault();
            break;
    }
});

function closePlayer() {
    stopProgressTracking();
    stopAdDetection();
    if (window.AndroidInterface && typeof AndroidInterface.closePlayer === "function") {
        AndroidInterface.closePlayer();
    } else {
        window.history.back();
    }
}

document.getElementById("retryButton").addEventListener("click", retryPlayer);
window.addEventListener("load", () => setTimeout(hideControls, 2000));
window.addEventListener("beforeunload", () => {
    stopProgressTracking();
    stopAdDetection();
});
</script>
</body>
</html>
