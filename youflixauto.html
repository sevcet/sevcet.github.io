<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV YouTube Player</title>

<style>
/* GLOBAL */
body, html {
    margin: 0; padding: 0;
    background: #000;
    width: 100%; height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

/* LOADING */
#loadingScreen {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000;
    color: white;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    z-index: 10000;
}
.spinner {
    width: 50px; height: 50px;
    border: 5px solid #333;
    border-top: 5px solid #ff4444;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

/* THUMBNAIL */
#customThumbnail {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    display: none;
    background-color:#000;
    background-size: cover;
    background-position: center;
    background-image: url("https://sevcet.github.io/tv_thumbnail.jpg");
    justify-content: center; align-items: center;
    z-index: 9998;
}

/* ERROR */
#errorScreen {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000;
    color: white;
    display: none;
    flex-direction: column;
    justify-content: center; align-items: center;
    z-index: 10000;
}

/* PROGRESS */
#progressContainer {
    position: absolute;
    bottom: 60px; left: 5%;
    width: 90%; height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 10001;
}
#progressBar {
    width: 0%; height: 100%;
    background: #ff4444;
    border-radius: 3px;
}

/* INFO PANEL */
#infoPanel {
    position: absolute;
    top: 30px; left: 30px;
    padding: 12px 18px;
    background: rgba(0,0,0,0.8);
    border-left: 4px solid #ff4444;
    border-radius: 6px;
    color: white;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 10001;
}

/* SEEK indicators */
.seek-indicator {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 10001;
}
#seekBackward { left: 30px; }
#seekForward { right: 30px; }

/* CC MENU */
#ccMenu {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 400px; max-height: 500px;
    padding: 20px;
    background: rgba(0,0,0,0.95);
    border-radius: 12px;
    display: flex; flex-direction: column;
    z-index: 10002;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}
#ccMenu.visible { opacity: 1; pointer-events: all; }

.menu-title {
    text-align: center;
    font-size: 20px;
    color: #ff4444;
    margin-bottom: 10px;
    border-bottom: 2px solid #333;
    padding-bottom: 10px;
}

.cc-options-container {
    flex: 1;
    overflow-y: auto;
    max-height: 400px;
}

.cc-option {
    background: rgba(255,255,255,0.1);
    margin: 5px 0;
    padding: 12px 15px;
    border-radius: 6px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
}
.cc-option:hover,
.cc-option.selected {
    background: rgba(255,68,68,0.3);
    border-color: #ff4444;
}

</style>
</head>

<body>

<!-- LOADING -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Uƒçitavam YouTube player...</div>
</div>

<!-- THUMBNAIL -->
<div id="customThumbnail"></div>

<!-- ERROR -->
<div id="errorScreen">
    <div id="errorText">Gre≈°ka pri uƒçitavanju</div>
    <button onclick="retryPlayer()">POKU≈†AJ PONOVO</button>
</div>

<!-- PLAYER -->
<div id="playerContainer">
    <div id="player"></div>
</div>

<!-- PROGRESS -->
<div id="progressContainer"><div id="progressBar"></div></div>

<!-- SEEK -->
<div id="seekBackward" class="seek-indicator">‚è™ -60s</div>
<div id="seekForward" class="seek-indicator">+60s ‚è©</div>

<!-- CC MENU -->
<div id="ccMenu">
    <div class="menu-title">üéØ Odabir titlova</div>
    <div id="ccOptions" class="cc-options-container"></div>
</div>

<div id="infoPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ===========================================================
   GLOBAL
=========================================================== */
let player;
let isPlaying = false;
let isCCMenuOpen = false;
let hideTimeout;
let currentSubs = [];
let selectedIndex = 0;

/* ===========================================================
   FUNKCIJA: AUTOMATSKI IZBOR NAJBOLJEG TITLA
=========================================================== */
function chooseBestSubtitle(system_lang, region, available) {
    system_lang = system_lang.toLowerCase();
    region = region.toUpperCase();

    const region_map = {
        "SK": ["sk","cs","en"], "CZ":["cs","sk","en"],
        "RS":["sr","en"], "HR":["hr","en"], "BA":["bs","en"], "ME":["sr","en"],
        "DE":["de","en"], "AT":["de","en"],
        "FR":["fr","en"], "IT":["it","en"],
        "TR":["tr","en"],
        "ES":["es","en"], "MX":["es","en"], "AR":["es","en"],
        "JP":["ja","en"], "KR":["ko","en"],
        "IN":["hi","en"], "PK":["ur","en"],
        "SA":["ar","en"], "AE":["ar","en"],
        "US":["en"], "GB":["en"], "AU":["en"], "CA":["en","fr"]
    };

    if (available.includes(system_lang)) return system_lang;

    if (region in region_map) {
        for (const lang of region_map[region]) {
            if (available.includes(lang)) return lang;
        }
    }

    if (available.includes("en")) return "en";

    return available.length ? available[0] : null;
}

/* ===========================================================
   AUTO TRANSLATE TITLOVI
=========================================================== */
function autoTranslateSubtitle(language) {
    try {
        player.loadModule("captions");
        setTimeout(() => {
            player.setOption("captions", "track", {
                languageCode: language,
                translate: true
            });
            player.setOption("captions", "reload", true);
        }, 300);
        showInfo("Titlovi (auto-prevod): " + language.toUpperCase());
    } catch (err) { console.error(err); }
}

/* ===========================================================
   UCITAVANJE LISTE TITLOVA IZ URL
=========================================================== */
function loadSubtitleList() {
    const params = new URLSearchParams(window.location.search);
    const subs = params.get("subs");
    if (!subs) return [];
    return subs.split(",").map(s => s.trim().toLowerCase());
}

/* ===========================================================
   CC MENI
=========================================================== */
function buildCCMenu(subs) {
    const ccOptions = document.getElementById("ccOptions");
    ccOptions.innerHTML = "";

    const off = document.createElement("div");
    off.className = "cc-option";
    off.dataset.language = "off";
    off.textContent = "‚ùå Bez titlova";
    ccOptions.appendChild(off);

    const sysLang = (navigator.language || "en").substring(0,2).toLowerCase();
    const auto = document.createElement("div");
    auto.className = "cc-option";
    auto.dataset.language = "auto";
    auto.textContent = "üåê Auto-prevod (" + sysLang + ")";
    ccOptions.appendChild(auto);

    subs.forEach(lang => {
        const div = document.createElement("div");
        div.className = "cc-option";
        div.dataset.language = lang;
        div.textContent = lang.toUpperCase();
        ccOptions.appendChild(div);
    });
}

/* ===========================================================
   YOUTUBE API INIT
=========================================================== */
function onYouTubeIframeAPIReady() { initializePlayer(); }

function initializePlayer() {
    const params = new URLSearchParams(window.location.search);
    const videoId = params.get("videoId");

    currentSubs = loadSubtitleList();
    buildCCMenu(currentSubs);

    player = new YT.Player("player", {
        videoId: videoId,
        playerVars: {
            autoplay: 1, controls: 0, rel: 0, fs: 1,
            modestbranding: 1, cc_load_policy: 1
        },
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange
        }
    });
}

/* ===========================================================
   AUTOMATSKO POSTAVLJANJE TITLOVA
=========================================================== */
function applyAutoSubs() {
    if (!currentSubs.length) return;

    const sysLang = (navigator.language || "en").substring(0,2).toLowerCase();
    const region = navigator.language.substring(3).toUpperCase();

    const best = chooseBestSubtitle(sysLang, region, currentSubs);

    if (best && currentSubs.includes(best)) {
        player.loadModule("captions");
        setTimeout(() => {
            player.setOption("captions", "track", { languageCode: best });
            player.setOption("captions", "reload", true);
        }, 300);
        return;
    }

    autoTranslateSubtitle(sysLang);
}

/* ===========================================================
   PLAYER EVENTS
=========================================================== */
function onPlayerReady() {
    document.getElementById("loadingScreen").style.display = "none";
    applyAutoSubs();
}

function onPlayerStateChange(e) {
    isPlaying = (e.data === YT.PlayerState.PLAYING);
}

/* ===========================================================
   RUƒåNO BIRANJE TITLOVA
=========================================================== */
function selectSub(language) {
    if (language === "off") {
        player.setOption("captions","track",{});
        showInfo("Titlovi iskljuƒçeni");
        return;
    }

    if (language === "auto") {
        const sysLang = (navigator.language || "en").substring(0,2).toLowerCase();
        autoTranslateSubtitle(sysLang);
        return;
    }

    player.loadModule("captions");
    setTimeout(() => {
        player.setOption("captions","track",{languageCode: language});
        player.setOption("captions","reload",true);
    }, 300);
}

/* ===========================================================
   TV DALJINSKI
=========================================================== */
document.addEventListener("keydown", function(e) {
    if (e.key === "ArrowUp") {
        document.getElementById("ccMenu").classList.toggle("visible");
        isCCMenuOpen = !isCCMenuOpen;
        return;
    }

    if (isCCMenuOpen) {
        const opts = document.querySelectorAll(".cc-option");

        if (e.key === "ArrowDown") {
            selectedIndex = (selectedIndex + 1) % opts.length;
        }
        if (e.key === "ArrowUp") {
            selectedIndex = (selectedIndex - 1 + opts.length) % opts.length;
        }
        if (e.key === "Enter") {
            const lang = opts[selectedIndex].dataset.language;
            selectSub(lang);
            document.getElementById("ccMenu").classList.remove("visible");
            isCCMenuOpen = false;
        }

        opts.forEach((opt, idx) =>
            opt.classList.toggle("selected", idx === selectedIndex)
        );
    }
});

/* ===========================================================
   INFO PANEL
=========================================================== */
function showInfo(msg) {
    const panel = document.getElementById("infoPanel");
    panel.textContent = msg;
    panel.style.opacity = "1";
    setTimeout(() => panel.style.opacity = "0", 3000);
}

</script>
</body>
</html>
