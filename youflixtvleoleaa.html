<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TV YouTube Player</title>

<style>
body, html {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
}

/* Loading screen */
#loadingScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
}
#loadingText {
    margin-top: 20px;
    font-size: 18px;
    text-align: center;
}
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #333;
    border-top: 5px solid #ff4444;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* PRAZAN THUMBNAIL */
#customThumbnail {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    opacity: 0;
    z-index: 9998;
    display: none;
}

/* Error screen */
#errorScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    text-align: center;
    padding: 20px;
}

#playerContainer {
    width: 100%;
    height: 100%;
    position: relative;
}
#player {
    width: 100%;
    height: 100%;
    border: none;
}

/* Progress bar */
#progressContainer {
    position: absolute;
    bottom: 60px;
    left: 5%;
    width: 90%;
    background: rgba(255,255,255,0.2);
    height: 6px;
    border-radius: 3px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#progressBar {
    height: 100%;
    background: #ff4444;
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

#infoPanel {
    position: absolute;
    top: 30px;
    left: 30px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-left: 4px solid #ff4444;
}

/* Seek indikatori */
.seek-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 18px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#seekBackward { left: 30px; }
#seekForward { right: 30px; }

#retryButton {
    background: #ff4444;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
}

/* Dugme za retry prevoda */
#retryTranslateBtn {
    position: absolute;
    bottom: 15px;
    right: 15px;
    z-index: 10002;
    background: rgba(0,0,0,0.8);
    color: #fff;
    border: 1px solid #ff4444;
    padding: 10px 18px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: none;
}
</style>
</head>

<body>

<!-- Loading -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouTube player...</div>
</div>

<!-- PRAZAN THUMBNAIL -->
<div id="customThumbnail"></div>

<!-- Error -->
<div id="errorScreen">
    <div id="errorText">Greška pri učitavanju YouTube playera</div>
    <div>Proverite internet konekciju</div>
    <button id="retryButton">POKUŠAJ PONOVO</button>
</div>

<!-- Player -->
<div id="playerContainer">
    <div id="player"></div>
</div>

<!-- Progress -->
<div id="progressContainer">
    <div id="progressBar"></div>
</div>

<div id="seekBackward" class="seek-indicator">⏪ -10s</div>
<div id="seekForward" class="seek-indicator">+10s ⏩</div>

<div id="infoPanel"></div>

<!-- Retry prevoda titlova -->
<button id="retryTranslateBtn">Pokušaj ponovo prijevod</button>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let hideTimeout;
let isPlaying = false;
let progressInterval;
let customThumbnail;
let stateCheckInterval;
let hasAdStarted = false;
let hasVideoStarted = false;

/* zapamćeni jezici za retry */
let currentSubLang;
let currentUserLang;

/* parametri iz URL-a */
const urlParams = new URLSearchParams(window.location.search);
const videoId   = urlParams.get("videoId");
const subLang   = urlParams.get("subLang") || "auto";   // izvorni titl koji film ima (npr. "en" ili "hr")
const userLang  = urlParams.get("userLang") || "en";    // jezik koji korisnik želi (npr. "hr", "sr")

currentSubLang = subLang;
currentUserLang = userLang;

function onYouTubeIframeAPIReady() {
    initializePlayer();
}

function initializePlayer() {
    customThumbnail = document.getElementById("customThumbnail");

    if (!videoId) {
        showError("Nema Video ID-a u URL-u");
        return;
    }

    try {
        player = new YT.Player("player", {
            height: "100%",
            width: "100%",
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                rel: 0,
                modestbranding: 1,
                controls: 0,
                showinfo: 0,
                fs: 1,
                iv_load_policy: 3,
                disablekb: 1,
                playsinline: 1,
                cc_load_policy: 1,
                enablejsapi: 1,
                hl: userLang
            },
            events: {
                onReady: onPlayerReady,
                onStateChange: onPlayerStateChange,
                onError: onPlayerError
            }
        });
    } catch (error) {
        showError("Greška pri pokretanju playera");
    }
}

function onPlayerReady() {
    document.getElementById("loadingScreen").style.display = "none";
    showCustomThumbnail();
    hideControls();
    startAdDetection();
    showInfo("← / → = -10s / +10s • ↑/↓ = Volume • ENTER = Play/Pause • BACK = zatvori");

    try { player.playVideo(); } catch (e) {}

    setTimeout(enableSubs, 2000);
    setTimeout(enableSubs, 5000);
}

/* Pomoćne funkcije za izbor tracka */
function findTrackByLang(tracks, lang) {
    if (!tracks || !lang) return null;

    // 1) pun pogodak: tačan kod
    let t = tracks.find(tr => tr.languageCode === lang);
    if (t) return t;

    // 2) kod sa sufiksom (hr-XXXX, en-XXXX, ...)
    t = tracks.find(tr =>
        tr.languageCode &&
        tr.languageCode.toLowerCase().startsWith(lang.toLowerCase() + "-")
    );
    if (t) return t;

    return null;
}

function pickBestSourceTrack(tracks) {
    if (!tracks || tracks.length === 0) return null;

    // prioritet: en, en-*
    let t = findTrackByLang(tracks, "en");
    if (t) return t;

    // ako nema en, uzmi prvi track (bolje bilo šta nego ništa)
    return tracks[0];
}

/* TITLOVI: prioritet userLang track -> source track -> auto + translate + fallback */
function enableSubs() {
    try {
        if (!player || !player.getOption) return;

        currentSubLang = subLang;
        currentUserLang = userLang;

        const tracks = player.getOption("captions", "tracklist");
        console.log("TRACKLIST =", tracks);
        console.log("subLang (source) =", subLang, "userLang (target) =", userLang);

        const retryBtn = document.getElementById("retryTranslateBtn");
        if (retryBtn) retryBtn.style.display = "none";

        // ako nema tracklist uopšte → auto captions + translate + fallback
        if (!tracks || tracks.length === 0) {
            console.log("No tracks from API, using auto captions");
            player.setOption("captions", "track", { languageCode: "auto" });
            player.setOption("captions", "translationLanguage", {
                languageCode: userLang
            });
            setTimeout(checkAutoFallback, 3000);
            return;
        }

        // 1) ako postoji track za userLang (npr. hr ili hr-xxxx) → koristi njega BEZ auto translate
        let userLangTrack = findTrackByLang(tracks, userLang);

        if (userLangTrack) {
            console.log("Using direct track for userLang:", userLangTrack);
            player.setOption("captions", "track", {
                languageCode: userLangTrack.languageCode
            });
            // nema translationLanguage, jer je već na jeziku korisnika
            showInfo("Titlovi: " + userLang + " (original ili već prevedeni)");
            return;
        }

        // 2) nema userLang track → bira se source za auto-translate
        let sourceTrack = null;

        if (subLang && subLang !== "auto") {
            sourceTrack = findTrackByLang(tracks, subLang);
        }

        if (!sourceTrack) {
            sourceTrack = pickBestSourceTrack(tracks);
        }

        console.log("Selected source track for translate =", sourceTrack);

        if (sourceTrack) {
            player.setOption("captions", "track", {
                languageCode: sourceTrack.languageCode
            });

            if (userLang && userLang !== "en") {
                player.setOption("captions", "translationLanguage", {
                    languageCode: userLang
                });
                console.log("translationLanguage set to", userLang);
                setTimeout(checkTranslateFallback, 3000);
            } else {
                // korisnik želi en ili nije definisan → nema translationLanguage
                showInfo("Titlovi: " + (userLang || sourceTrack.languageCode));
            }
        } else {
            // fallback: ništa pametno → auto
            console.log("No suitable source track, falling back to auto captions");
            player.setOption("captions", "track", { languageCode: "auto" });
            if (userLang && userLang !== "en") {
                player.setOption("captions", "translationLanguage", {
                    languageCode: userLang
                });
                setTimeout(checkAutoFallback, 3000);
            }
        }

    } catch (e) {
        console.log("Subtitle controller error:", e);
    }
}

function checkTranslateFallback() {
    try {
        const afterTrack = player.getOption("captions", "track");
        console.log("AFTER TRANSLATION track =", afterTrack);

        const retryBtn = document.getElementById("retryTranslateBtn");

        if (!afterTrack || !afterTrack.languageCode) {
            showInfo("Titlovi nisu dostupni za ovaj video.");
            if (retryBtn) retryBtn.style.display = "none";
            return;
        }

        if (afterTrack.languageCode === userLang) {
            showInfo("Titlovi: " + userLang + " (prevod)");
            if (retryBtn) retryBtn.style.display = "none";
            return;
        }

        if (afterTrack.languageCode !== userLang && userLang !== "en") {
            console.log("Fallback to EN translation");
            player.setOption("captions", "translationLanguage", {
                languageCode: "en"
            });
            showInfo("Prevod na " + userLang + " nije dostupan, prikazuju se engleski titlovi.");
            if (retryBtn) retryBtn.style.display = "block";
        } else {
            if (retryBtn) retryBtn.style.display = "none";
        }
    } catch (e) {
        console.log("checkTranslateFallback error:", e);
    }
}

function checkAutoFallback() {
    try {
        const afterTrack = player.getOption("captions", "track");
        console.log("AFTER AUTO track =", afterTrack);

        const retryBtn = document.getElementById("retryTranslateBtn");

        if (!afterTrack || !afterTrack.languageCode) {
            showInfo("Titlovi nisu dostupni za ovaj video.");
            if (retryBtn) retryBtn.style.display = "none";
            return;
        }

        if (afterTrack.languageCode === userLang) {
            showInfo("Titlovi: " + userLang + " (auto prevod)");
            if (retryBtn) retryBtn.style.display = "none";
            return;
        }

        if (afterTrack.languageCode !== userLang && userLang !== "en") {
            console.log("Fallback(auto) to EN translation");
            player.setOption("captions", "translationLanguage", {
                languageCode: "en"
            });
            showInfo("Prevod na " + userLang + " nije dostupan, prikazuju se engleski titlovi.");
            if (retryBtn) retryBtn.style.display = "block";
        } else {
            if (retryBtn) retryBtn.style.display = "none";
        }
    } catch (e) {
        console.log("checkAutoFallback error:", e);
    }
}

/* handler za retry prevoda */
document.addEventListener("DOMContentLoaded", () => {
    const retryTranslateBtn = document.getElementById("retryTranslateBtn");
    if (retryTranslateBtn) {
        retryTranslateBtn.addEventListener("click", () => {
            console.log("Retry translate clicked for", currentSubLang, currentUserLang);
            showInfo("Pokušavam ponovo prevod na " + currentUserLang + "…");
            enableSubs();
        });
    }
});

/* STANJE + REKLAME */
function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
        hideCustomThumbnail();
        isPlaying = true;
        startProgressTracking();
        checkIfAdOrVideo();
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        stopProgressTracking();
    } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        stopProgressTracking();
        showCustomThumbnail();
        hasVideoStarted = false;
        hasAdStarted = false;
        showInfo("Video završen");
    } else if (event.data === YT.PlayerState.BUFFERING) {
        setTimeout(checkBuffering, 2000);
    } else if (event.data === YT.PlayerState.UNSTARTED) {
        showCustomThumbnail();
    }

    resetHideTimer();
}

function checkIfAdOrVideo() {
    if (!player) return;
    const currentTime = player.getCurrentTime();
    if (currentTime === 0 && !hasVideoStarted) hasAdStarted = true;
    else hasVideoStarted = true;
}

function checkBuffering() {
    if (player && player.getPlayerState() === YT.PlayerState.BUFFERING)
        showCustomThumbnail();
}

function startAdDetection() {
    stateCheckInterval = setInterval(function() {
        if (player && player.getPlayerState && player.getCurrentTime) {
            const state = player.getPlayerState();
            const currentTime = player.getCurrentTime();
            if (state === YT.PlayerState.PAUSED && currentTime < 2 && hasAdStarted)
                showCustomThumbnail();
            if (state === YT.PlayerState.BUFFERING && currentTime < 2 && hasAdStarted)
                showCustomThumbnail();
            if (state === YT.PlayerState.UNSTARTED) showCustomThumbnail();
            if (state === YT.PlayerState.ENDED) showCustomThumbnail();
        }
    }, 500);
}

function stopAdDetection() {
    if (stateCheckInterval) clearInterval(stateCheckInterval);
}

function onPlayerError(event) {
    showError("YouTube greška: " + event.data);
}

/* THUMBNAIL overlay */
function showCustomThumbnail() {
    if (customThumbnail && customThumbnail.style.display === "none")
        customThumbnail.style.display = "flex";
}
function hideCustomThumbnail() {
    if (customThumbnail && customThumbnail.style.display !== "none")
        customThumbnail.style.display = "none";
}

/* PROGRESS BAR */
function startProgressTracking() {
    stopProgressTracking();
    progressInterval = setInterval(updateProgress, 1000);
}
function stopProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}
function updateProgress() {
    if (player && player.getCurrentTime && player.getDuration) {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();
        const progress = (currentTime / duration) * 100;
        document.getElementById("progressBar").style.width = progress + "%";
    }
}

/* SEEK + PLAY/PAUSE */
function seek(direction) {
    if (!player) return;
    const seekAmount = 10;
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration();
    const newTime = Math.max(0, Math.min(duration, currentTime + (direction * seekAmount)));
    player.seekTo(newTime, true);
}

function togglePlayPause() {
    if (!player) return;
    if (isPlaying) player.pauseVideo();
    else player.playVideo();
}

/* VOLUME */
function volumeChange(delta) {
    if (!player || typeof player.getVolume !== "function") return;
    try {
        const v = player.getVolume();
        const nv = Math.max(0, Math.min(100, v + delta));
        player.setVolume(nv);
        showInfo("Volume: " + nv + "%");
    } catch (e) {
        console.log("volumeChange error:", e);
    }
}

/* CONTROLS overlay */
function showControls() {
    document.getElementById("progressContainer").style.opacity = "1";
    resetHideTimer();
}
function hideControls() {
    document.getElementById("progressContainer").style.opacity = "0";
    clearTimeout(hideTimeout);
}
function showControlsTemporary() {
    showControls();
    resetHideTimer();
}
function resetHideTimer() {
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(hideControls, 3000);
}

/* ZATVARANJE PLAYERA */
function closePlayer() {
    stopProgressTracking();
    stopAdDetection();
    if (window.AndroidInterface && typeof AndroidInterface.closePlayer === "function") {
        AndroidInterface.closePlayer();
    } else {
        window.history.back();
    }
}

/* INFO PANEL */
function showInfo(message) {
    const infoPanel = document.getElementById("infoPanel");
    infoPanel.textContent = message;
    infoPanel.style.opacity = "1";
    setTimeout(() => { infoPanel.style.opacity = "0"; }, 3000);
}

/* ERROR HANDLING */
function showError(message) {
    document.getElementById("loadingScreen").style.display = "none";
    const e = document.getElementById("errorScreen");
    e.style.display = "flex";
    document.getElementById("errorText").textContent = message;
}
function retryPlayer() {
    document.getElementById("errorScreen").style.display = "none";
    document.getElementById("loadingScreen").style.display = "flex";
    initializePlayer();
}

/* DPAD / tastatura */
document.addEventListener("keydown", event => {
    showControlsTemporary();

    switch (event.key) {
        case "ArrowLeft":
            seek(-1);
            event.preventDefault();
            break;
        case "ArrowRight":
            seek(1);
            event.preventDefault();
            break;
        case "ArrowUp":
            volumeChange(+10);
            event.preventDefault();
            break;
        case "ArrowDown":
            volumeChange(-10);
            event.preventDefault();
            break;
        case "Enter":
        case " ":
            togglePlayPause();
            event.preventDefault();
            break;
        case "Escape":
        case "Backspace":
            try { if (player) player.pauseVideo(); } catch (e) {}
            closePlayer();
            event.preventDefault();
            break;
    }
});

document.addEventListener("mousemove", showControlsTemporary);
document.addEventListener("click", showControlsTemporary);
document.getElementById("retryButton").addEventListener("click", retryPlayer);
window.addEventListener("load", () => setTimeout(hideControls, 2000));
window.addEventListener("beforeunload", () => stopProgressTracking());
</script>

</body>
</html>
