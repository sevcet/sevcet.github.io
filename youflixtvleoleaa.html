<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TV YouTube Player</title>

<style>
body, html {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
}

/* Loading screen */
#loadingScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
}
#loadingText {
    margin-top: 20px;
    font-size: 18px;
    text-align: center;
}
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #333;
    border-top: 5px solid #ff4444;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* PRAZAN THUMBNAIL */
#customThumbnail {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    opacity: 0;
    z-index: 9998;
    display: none;
}

/* Error screen */
#errorScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    text-align: center;
    padding: 20px;
}

#playerContainer {
    width: 100%;
    height: 100%;
    position: relative;
}
#player {
    width: 100%;
    height: 100%;
    border: none;
}

/* Progress bar */
#progressContainer {
    position: absolute;
    bottom: 60px;
    left: 5%;
    width: 90%;
    background: rgba(255,255,255,0.2);
    height: 6px;
    border-radius: 3px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#progressBar {
    height: 100%;
    background: #ff4444;
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

/* infoPanel (trenutno ga ne koristimo, ali je tu ako zatreba) */
#infoPanel {
    position: absolute;
    top: 20px;
    left: 20px;
    max-width: 60%;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-left: 3px solid #ff4444;
}

/* Seek indikatori */
.seek-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 18px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#seekBackward { left: 30px; }
#seekForward { right: 30px; }

#retryButton {
    background: #ff4444;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
}
</style>
</head>

<body>

<!-- Loading -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouTube player...</div>
</div>

<!-- PRAZAN THUMBNAIL -->
<div id="customThumbnail"></div>

<!-- Error -->
<div id="errorScreen">
    <div id="errorText">Greška pri učitavanju YouTube playera</div>
    <div>Proverite internet konekciju</div>
    <button id="retryButton">POKUŠAJ PONOVO</button>
</div>

<!-- Player -->
<div id="playerContainer">
    <div id="player"></div>
</div>

<!-- Progress -->
<div id="progressContainer">
    <div id="progressBar"></div>
</div>

<div id="seekBackward" class="seek-indicator">⏪ -10s</div>
<div id="seekForward" class="seek-indicator">+10s ⏩</div>

<div id="infoPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let hideTimeout;
let isPlaying = false;
let progressInterval;
let customThumbnail;
let stateCheckInterval;
let hasAdStarted = false;
let hasVideoStarted = false;

/* parametri iz URL-a */
const urlParams = new URLSearchParams(window.location.search);
const videoId   = urlParams.get("videoId");
const subLang   = urlParams.get("subLang") || "auto";   // hint za izvorni titl
const userLang  = urlParams.get("userLang") || "en";    // željeni jezik (bez auto-prevoda)

function onYouTubeIframeAPIReady() {
    initializePlayer();
}

function initializePlayer() {
    customThumbnail = document.getElementById("customThumbnail");

    if (!videoId) {
        showError("Nema Video ID-a u URL-u");
        return;
    }

    try {
        player = new YT.Player("player", {
            height: "100%",
            width: "100%",
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                rel: 0,
                modestbranding: 1,
                controls: 0,
                fs: 1,
                iv_load_policy: 3,
                disablekb: 1,
                playsinline: 1,
                cc_load_policy: 1,
                enablejsapi: 1,
                hl: userLang
            },
            events: {
                onReady: onPlayerReady,
                onStateChange: onPlayerStateChange,
                onError: onPlayerError
            }
        });
    } catch (error) {
        showError("Greška pri pokretanju playera");
    }
}

function onPlayerReady() {
    document.getElementById("loadingScreen").style.display = "none";
    showCustomThumbnail();
    hideControls();
    startAdDetection();

    try { player.playVideo(); } catch (e) {}
}

/* pomoćne funkcije za trackove */
function findTrackByLang(tracks, lang) {
    if (!tracks || !lang) return null;

    let t = tracks.find(tr =>
        tr.languageCode &&
        tr.languageCode.toLowerCase().startsWith(lang.toLowerCase() + "-holatrt")
    );
    if (t) return t;

    t = tracks.find(tr => tr.languageCode === lang);
    if (t) return t;

    t = tracks.find(tr =>
        tr.languageCode &&
        tr.languageCode.toLowerCase().startsWith(lang.toLowerCase() + "-")
    );
    if (t) return t;

    return null;
}

function pickBestSourceTrack(tracks) {
    if (!tracks || tracks.length === 0) return null;
    let t = findTrackByLang(tracks, "en");
    if (t) return t;
    return tracks[0];
}

/* srodni jezici (isti koncept kao u app) */
function mapUserLangToEffective(lang, tracks) {
    if (!lang) return lang;
    const L = lang.toLowerCase();

    function has(langCode) {
        return !!findTrackByLang(tracks, langCode);
    }

    // ex-YU
    if (L === "sr" || L === "sr-latn" || L === "sr-latn-rs") {
        if (has("sr")) return "sr";
        if (has("hr")) return "hr";
        if (has("bs")) return "bs";
        if (has("mk")) return "mk";
        return "sr";
    }
    if (L === "bs") {
        if (has("bs")) return "bs";
        if (has("hr")) return "hr";
        if (has("sr")) return "sr";
        if (has("mk")) return "mk";
        return "bs";
    }
    if (L === "hr") {
        if (has("hr")) return "hr";
        if (has("bs")) return "bs";
        if (has("sr")) return "sr";
        if (has("mk")) return "mk";
        return "hr";
    }
    if (L === "mk") {
        if (has("mk")) return "mk";
        if (has("hr")) return "hr";
        if (has("sr")) return "sr";
        if (has("bs")) return "bs";
        return "mk";
    }
    if (L === "sl") {
        if (has("sl")) return "sl";
        if (has("hr")) return "hr";
        if (has("sr")) return "sr";
        return "sl";
    }

    // slovenski šire
    if (L === "sk") {
        if (has("sk")) return "sk";
        if (has("cs")) return "cs";
        if (has("pl")) return "pl";
        if (has("sl")) return "sl";
        return "sk";
    }
    if (L === "cs") {
        if (has("cs")) return "cs";
        if (has("sk")) return "sk";
        if (has("pl")) return "pl";
        if (has("sl")) return "sl";
        return "cs";
    }
    if (L === "pl") {
        if (has("pl")) return "pl";
        if (has("cs")) return "cs";
        if (has("sk")) return "sk";
        return "pl";
    }

    // romanski
    if (L === "es" || L === "es-419") {
        if (has("es")) return "es";
        if (has("es-419")) return "es-419";
        if (has("pt")) return "pt";
        if (has("it")) return "it";
        if (has("fr")) return "fr";
        return "es";
    }
    if (L === "pt" || L === "pt-br") {
        if (has("pt-br")) return "pt-br";
        if (has("pt")) return "pt";
        if (has("es")) return "es";
        if (has("it")) return "it";
        if (has("fr")) return "fr";
        return "pt";
    }
    if (L === "fr") {
        if (has("fr")) return "fr";
        if (has("it")) return "it";
        if (has("es")) return "es";
        if (has("pt")) return "pt";
        return "fr";
    }
    if (L === "it") {
        if (has("it")) return "it";
        if (has("es")) return "es";
        if (has("fr")) return "fr";
        if (has("pt")) return "pt";
        return "it";
    }
    if (L === "ro") {
        if (has("ro")) return "ro";
        if (has("it")) return "it";
        if (has("es")) return "es";
        if (has("fr")) return "fr";
        if (has("pt")) return "pt";
        return "ro";
    }

    // germanski / nordijski
    if (L === "de") {
        if (has("de")) return "de";
        if (has("nl")) return "nl";
        if (has("sv")) return "sv";
        if (has("no")) return "no";
        if (has("da")) return "da";
        return "de";
    }
    if (L === "nl") {
        if (has("nl")) return "nl";
        if (has("de")) return "de";
        if (has("sv")) return "sv";
        if (has("no")) return "no";
        if (has("da")) return "da";
        return "nl";
    }
    if (L === "sv") {
        if (has("sv")) return "sv";
        if (has("no")) return "no";
        if (has("da")) return "da";
        if (has("de")) return "de";
        return "sv";
    }
    if (L === "no") {
        if (has("no")) return "no";
        if (has("sv")) return "sv";
        if (has("da")) return "da";
        if (has("de")) return "de";
        return "no";
    }
    if (L === "da") {
        if (has("da")) return "da";
        if (has("no")) return "no";
        if (has("sv")) return "sv";
        if (has("de")) return "de";
        return "da";
    }

    // istočno-slovenski
    if (L === "ru") {
        if (has("ru")) return "ru";
        if (has("uk")) return "uk";
        if (has("bg")) return "bg";
        return "ru";
    }
    if (L === "uk") {
        if (has("uk")) return "uk";
        if (has("ru")) return "ru";
        if (has("bg")) return "bg";
        return "uk";
    }
    if (L === "bg") {
        if (has("bg")) return "bg";
        if (has("ru")) return "ru";
        if (has("uk")) return "uk";
        return "bg";
    }

    // hi / ur
    if (L === "hi") {
        if (has("hi")) return "hi";
        if (has("ur")) return "ur";
        return "hi";
    }
    if (L === "ur") {
        if (has("ur")) return "ur";
        if (has("hi")) return "hi";
        return "ur";
    }

    // default
    return lang;
}

/* TITLOVI: bez auto-prevoda, samo direktan/srodan track */
function enableSubs() {
    try {
        if (!player || !player.getOption) return;

        const tracks = player.getOption("captions", "tracklist");
        console.log("TRACKLIST =", tracks);
        console.log("subLang =", subLang, "userLang =", userLang);

        if (!tracks || tracks.length === 0) {
            console.log("No caption tracks available");
            return;
        }

        const effectiveUserLang = mapUserLangToEffective(userLang, tracks);
        console.log("effectiveUserLang =", effectiveUserLang);

        let userLangTrack = findTrackByLang(tracks, effectiveUserLang);
        if (userLangTrack) {
            console.log("Using direct track for effectiveUserLang:", userLangTrack);
            player.setOption("captions", "track", {
                languageCode: userLangTrack.languageCode
            });
            setTimeout(reportActiveTrack, 3000);
            return;
        }

        let sourceTrack = null;
        if (subLang && subLang !== "auto") {
            sourceTrack = findTrackByLang(tracks, subLang);
        }
        if (!sourceTrack) {
            sourceTrack = pickBestSourceTrack(tracks);
        }

        if (sourceTrack) {
            console.log("Fallback subtitle track =", sourceTrack);
            player.setOption("captions", "track", {
                languageCode: sourceTrack.languageCode
            });
        }

        setTimeout(reportActiveTrack, 3000);
    } catch (e) {
        console.log("Subtitle controller error:", e);
    }
}

function reportActiveTrack() {
    try {
        const t = player.getOption("captions", "track");
        console.log("ACTIVE CAPTION TRACK =", t);
        // infoPanel ne koristimo – nema dijaloga
    } catch (e) {
        console.log("reportActiveTrack error:", e);
    }
}

/* STANJE + REKLAME */
function onPlayerStateChange(event) {
    console.log("onPlayerStateChange:", event.data);
    if (event.data === YT.PlayerState.PLAYING) {
        hideCustomThumbnail();
        isPlaying = true;
        startProgressTracking();
        detectMainVideoStart();
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        stopProgressTracking();
    } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        stopProgressTracking();
        showCustomThumbnail();
        hasVideoStarted = false;
        hasAdStarted = false;
    } else if (event.data === YT.PlayerState.BUFFERING) {
        setTimeout(checkBuffering, 2000);
    } else if (event.data === YT.PlayerState.UNSTARTED) {
        showCustomThumbnail();
    }

    resetHideTimer();
}

/* reklame vs glavni video: titlove radimo tek kad glavni video stvarno krene */
function detectMainVideoStart() {
    if (!player) return;
    const t = player.getCurrentTime();

    if (!hasVideoStarted && t > 2) {
        hasVideoStarted = true;
        console.log("Main video detected, enabling subtitles");
        setTimeout(enableSubs, 1000);
        setTimeout(enableSubs, 4000);
    }

    if (t === 0 && !hasVideoStarted) {
        hasAdStarted = true;
    }
}

function checkBuffering() {
    if (player && player.getPlayerState() === YT.PlayerState.BUFFERING)
        showCustomThumbnail();
}

function startAdDetection() {
    stateCheckInterval = setInterval(function() {
        if (player && player.getPlayerState && player.getCurrentTime) {
            const state = player.getPlayerState();
            const currentTime = player.getCurrentTime();
            if (state === YT.PlayerState.UNSTARTED) showCustomThumbnail();
            if (state === YT.PlayerState.ENDED) showCustomThumbnail();
        }
    }, 500);
}

function stopAdDetection() {
    if (stateCheckInterval) clearInterval(stateCheckInterval);
}

function onPlayerError(event) {
    showError("YouTube greška: " + event.data);
}

/* THUMBNAIL overlay */
function showCustomThumbnail() {
    if (customThumbnail && customThumbnail.style.display === "none")
        customThumbnail.style.display = "flex";
}
function hideCustomThumbnail() {
    if (customThumbnail && customThumbnail.style.display !== "none")
        customThumbnail.style.display = "none";
}

/* PROGRESS BAR */
function startProgressTracking() {
    stopProgressTracking();
    progressInterval = setInterval(updateProgress, 1000);
}
function stopProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}
function updateProgress() {
    if (player && player.getCurrentTime && player.getDuration) {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();
        const progress = (currentTime / duration) * 100;
        document.getElementById("progressBar").style.width = progress + "%";
    }
}

/* SEEK + PLAY/PAUSE */
function seek(direction) {
    if (!player) return;
    const seekAmount = 10;
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration();
    const newTime = Math.max(0, Math.min(duration, currentTime + (direction * seekAmount)));
    player.seekTo(newTime, true);
}

function togglePlayPause() {
    if (!player) return;
    if (isPlaying) player.pauseVideo();
    else player.playVideo();
}

/* VOLUME */
function volumeChange(delta) {
    if (!player || typeof player.getVolume !== "function") return;
    try {
        const v = player.getVolume();
        const nv = Math.max(0, Math.min(100, v + delta));
        player.setVolume(nv);
    } catch (e) {
        console.log("volumeChange error:", e);
    }
}

/* CONTROLS overlay */
function showControls() {
    document.getElementById("progressContainer").style.opacity = "1";
    resetHideTimer();
}
function hideControls() {
    document.getElementById("progressContainer").style.opacity = "0";
    clearTimeout(hideTimeout);
}
function showControlsTemporary() {
    showControls();
    resetHideTimer();
}
function resetHideTimer() {
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(hideControls, 3000);
}

/* ZATVARANJE PLAYERA */
function closePlayer() {
    stopProgressTracking();
    stopAdDetection();
    if (window.AndroidInterface && typeof AndroidInterface.closePlayer === "function") {
        AndroidInterface.closePlayer();
    } else {
        window.history.back();
    }
}

/* INFO PANEL – sada ne prikazuje ništa */
function showInfo(message) {
    const infoPanel = document.getElementById("infoPanel");
    infoPanel.style.opacity = "0";
}

/* ERROR HANDLING */
function showError(message) {
    document.getElementById("loadingScreen").style.display = "none";
    const e = document.getElementById("errorScreen");
    e.style.display = "flex";
    document.getElementById("errorText").textContent = message;
}
function retryPlayer() {
    document.getElementById("errorScreen").style.display = "none";
    document.getElementById("loadingScreen").style.display = "flex";
    initializePlayer();
}

/* DPAD / tastatura */
document.addEventListener("keydown", event => {
    showControlsTemporary();

    switch (event.key) {
        case "ArrowLeft":
            seek(-1);
            event.preventDefault();
            break;
        case "ArrowRight":
            seek(1);
            event.preventDefault();
            break;
        case "ArrowUp":
            volumeChange(+10);
            event.preventDefault();
            break;
        case "ArrowDown":
            volumeChange(-10);
            event.preventDefault();
            break;
        case "Enter":
        case " ":
            togglePlayPause();
            event.preventDefault();
            break;
        case "Escape":
        case "Backspace":
            try { if (player) player.pauseVideo(); } catch (e) {}
            closePlayer();
            event.preventDefault();
            break;
    }
});

document.addEventListener("mousemove", showControlsTemporary);
document.addEventListener("click", showControlsTemporary);
document.getElementById("retryButton").addEventListener("click", retryPlayer);
window.addEventListener("load", () => setTimeout(hideControls, 2000));
window.addEventListener("beforeunload", () => stopProgressTracking());
</script>

</body>
</html>
