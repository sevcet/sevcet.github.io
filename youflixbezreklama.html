<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouFlix Player</title>

<style>
    html, body {
        margin:0; padding:0;
        width:100%; height:100%;
        background:#000;
        overflow:hidden;
        font-family:Arial, sans-serif;
    }

    #player {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        z-index:1;
    }

    #loading {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        background:black;
        color:white;
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        z-index:5;
    }

    #subtitleMenu {
        position:absolute;
        top:120px;
        right:120px;
        width:360px;
        max-height:60%;
        overflow-y:auto;
        background:rgba(0,0,0,0.85);
        border:2px solid #fff;
        border-radius:12px;
        padding:12px;
        color:white;
        display:none;
        z-index:10;
    }

    .menuItem {
        padding:10px;
        background:#222;
        border-radius:6px;
        margin-bottom:6px;
    }
    .menuItem.focused {
        background:#555;
        border:2px solid #fff;
    }

    #toast {
        position:absolute;
        top:40px;
        left:50%;
        transform:translateX(-50%);
        background:rgba(20,20,20,0.85);
        padding:12px 24px;
        border-radius:10px;
        color:white;
        opacity:0;
        transition:opacity .4s;
        z-index:10;
    }
</style>
</head>

<body>

<div id="loading">
    <div style="border:5px solid #444;border-top:5px solid red;width:50px;height:50px;border-radius:50%;animation:spin 1s linear infinite;"></div>
    <div style="margin-top:20px;font-size:18px;">Loading video...</div>
</div>

<div id="toast"></div>
<div id="subtitleMenu"></div>

<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
const params = new URLSearchParams(window.location.search);
const VIDEO_ID = params.get("videoId");
const USER_LANG = (params.get("lang") || "en").toLowerCase();

const RELATED = {
    "sr":["bs","hr","me"],
    "bs":["sr","hr","me"],
    "hr":["sr","bs","me"],
    "me":["sr","bs","hr"],
    "sk":["cs"],
    "cs":["sk"],
    "sl":["hr","sr"],
    "pl":["cs","sk"],
    "da":["sv","no"],
    "sv":["da","no","is"],
    "no":["sv","da"],
    "is":["sv"],
    "mk":["bg","sr"],
    "bg":["mk","sr"],
    "uk":["ru"],
    "ru":["uk"],
    "fr":["es","it","pt"],
    "es":["fr","pt","it"],
    "pt":["es","fr","it"],
    "it":["es","fr","pt"],
    "zh":["ja","ko"],
    "ja":["zh","ko"],
    "ko":["zh","ja"]
};

let player, availableSubs = [];
let realVideoStarted = false;
let menuOpen = false;
let menuIndex = 0;

function onYouTubeIframeAPIReady(){
    player = new YT.Player("player", {
        width:"100%",
        height:"100%",
        videoId: VIDEO_ID,
        playerVars:{
            autoplay:1,
            controls:1,
            rel:0,
            fs:1,
            hl:USER_LANG,
            iv_load_policy:3,
            modestbranding:1
        },
        events:{
            onReady:onReady,
            onStateChange:onStateChange
        }
    });
}

function onReady(){
    // sakrij loading nakon kratkog vremena
    setTimeout(() => {
        document.getElementById("loading").style.display = "none";
    }, 700);
}

function onStateChange(e){
    if (e.data === 1 && !realVideoStarted){
        realVideoStarted = true;
        initSubs();
    }
}

function initSubs(){
    let tracks = [];
    try{
        tracks = player.getOption("captions","tracklist") || [];
    }catch(e){}

    availableSubs = tracks.map(t => t.languageCode.toLowerCase());

    applyAutoSub();
}

function applyAutoSub(){
    let lang = USER_LANG;

    if (!availableSubs.includes(lang)){
        if (RELATED[lang]){
            for (let r of RELATED[lang]){
                if (availableSubs.includes(r)){
                    lang = r;
                    break;
                }
            }
        }
    }

    if (!availableSubs.includes(lang)){
        if (availableSubs.includes("en"))
            lang = "en";
    }

    if (availableSubs.includes(lang)){
        player.setOption("captions","track",{languageCode:lang});
        toast("Subtitle: " + lang.toUpperCase());
    }
}

function openSubtitleMenu(){
    const menu = document.getElementById("subtitleMenu");
    menu.innerHTML = "";

    availableSubs.forEach(l => {
        menu.innerHTML += `<div class="menuItem" data-lang="${l}">${l.toUpperCase()}</div>`;
    });

    menu.style.display = "block";
    menuOpen = true;
    menuIndex = 0;
    updateFocus();
}

function closeSubtitleMenu(){
    document.getElementById("subtitleMenu").style.display = "none";
    menuOpen = false;
}

function updateFocus(){
    const items = document.querySelectorAll(".menuItem");
    items.forEach(i => i.classList.remove("focused"));
    if (items[menuIndex]) items[menuIndex].classList.add("focused");
}

function activateItem(){
    const items = document.querySelectorAll(".menuItem");
    const sel = items[menuIndex];
    if (!sel) return;

    const lang = sel.getAttribute("data-lang");
    player.setOption("captions","track",{languageCode:lang});
    toast("Subtitle: " + lang.toUpperCase());
    closeSubtitleMenu();
}

document.addEventListener("keydown", e => {

    if (menuOpen){
        const items = document.querySelectorAll(".menuItem");

        if (e.key === "ArrowDown"){
            menuIndex = Math.min(menuIndex + 1, items.length - 1);
            updateFocus();
            return;
        }
        if (e.key === "ArrowUp"){
            menuIndex = Math.max(menuIndex - 1, 0);
            updateFocus();
            return;
        }
        if (e.key === "Enter"){
            activateItem();
            return;
        }
        if (e.key === "Backspace" || e.key === "Escape"){
            closeSubtitleMenu();
            return;
        }
        return;
    }

    switch(e.key){
        case "ArrowUp":
            openSubtitleMenu();
            break;

        case "ArrowLeft":
            player.seekTo(player.getCurrentTime() - 20, true);
            break;

        case "ArrowRight":
            player.seekTo(player.getCurrentTime() + 20, true);
            break;

        case "Enter":
            let st = player.getPlayerState();
            if (st === 1) player.pauseVideo();
            else player.playVideo();
            break;
    }
});

let tmr=null;
function toast(msg){
    const t=document.getElementById("toast");
    t.innerHTML=msg;
    t.style.opacity=1;
    clearTimeout(tmr);
    tmr=setTimeout(()=>t.style.opacity=0,2500);
}
</script>
/* =======================================================================
   REMOVE YouTube dark overlay (ads dimming) – FULL FIX
   ======================================================================= */
function removeDarkOverlay() {
    try {
        const selectors = [
            ".ytp-ad-player-overlay",
            ".ytp-ad-overlay-slot",
            ".ytp-ad-text-overlay",
            ".ytp-ad-image-overlay",
            ".ytp-ad-preview-container",
            ".ytp-ad-progress-list",
            ".ytp-ad-overlay-container",
            ".ytp-ad-message-container",
            ".video-ads",
            ".ytp-paid-content-overlay",
            ".ytp-preview-ad",
            ".ytp-ad-bottom-bar",
            ".ytp-ad-skip-button-slot"
        ];

        selectors.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => {
                el.style.display = "none";
                el.style.opacity = "0";
                el.remove();
            });
        });

        // YouTube ubaci ponekad veliki crni DIV preko celog ekrana
        const blockers = document.querySelectorAll("div");
        blockers.forEach(div => {
            const cs = getComputedStyle(div);
            if (
                cs.backgroundColor === "rgb(0, 0, 0)" &&
                parseInt(cs.zIndex) > 100 &&
                div.clientHeight > window.innerHeight / 2
            ) {
                div.style.display = "none";
                div.remove();
            }
        });

    } catch (e) { console.log("Overlay remover error:", e); }
}

/* Run every 300ms (sigurno skida sve slojeve) */
setInterval(removeDarkOverlay, 300);

/* Takođe pozovi odmah posle učitavanja videa */
document.addEventListener("DOMContentLoaded", removeDarkOverlay);
window.addEventListener("load", removeDarkOverlay);


</body>
</html>
