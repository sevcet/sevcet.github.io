<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>YouFlix Player v3</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        background: black;
        height: 100%;
        overflow: hidden;
    }
    #player {
        width: 100%;
        height: 100%;
    }
</style>
</head>
<body>

<div id="player"></div>

<script>
    const url = new URL(window.location.href);
    const videoId = url.searchParams.get("videoId");
    const userLang = url.searchParams.get("lang") || "sr";

    let player;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player("player", {
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                controls: 1,
                cc_load_policy: 1,
                hl: userLang
            },
            events: {
                "onReady": onPlayerReady,
                "onStateChange": onPlayerStateChange
            }
        });
    }

    function onPlayerReady() {
        player.playVideo();
        enableSubs();
    }

    function onPlayerStateChange(e) {
        if (e.data === YT.PlayerState.PLAYING) {
            enableSubs();
        }
    }

    function enableSubs() {
        try {
            const tracks = player.getOption("captions", "tracklist");

            if (!tracks || tracks.length === 0) {
                player.setOption("captions", "track", {"languageCode": "auto"});
                return;
            }

            let selected = tracks.find(t => t.languageCode === userLang);
            if (!selected) {
                selected = tracks.find(t => t.languageCode === "en");
            }
            if (!selected) {
                selected = tracks[0];
            }

            player.setOption("captions", "track", {
                languageCode: selected.languageCode
            });

            // auto translate ako postoji moguÄ‡nost
            if (selected.kind === "asr") {
                player.setOption("captions", "translationLanguage", { languageCode: userLang });
            }

        } catch (e) {
            console.log("Subtitle controller error:", e);
        }
    }

    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
</script>

</body>
</html>
