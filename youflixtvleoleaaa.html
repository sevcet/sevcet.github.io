<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV YouTube Player</title>

<!-- Brže povezivanje sa YouTube serverima -->
<link rel="preconnect" href="https://www.youtube.com">
<link rel="preconnect" href="https://s.ytimg.com">
<link rel="dns-prefetch" href="https://www.youtube.com">

<style>
body, html {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
}

/* Loading screen */
#loadingScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
}
#loadingText {
    margin-top: 20px;
    font-size: 18px;
    text-align: center;
}
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #333;
    border-top: 5px solid #ff4444;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* PRAZAN THUMBNAIL */
#customThumbnail {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    opacity: 0;
    z-index: 9998;
    display: none;
}

/* Error screen */
#errorScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    text-align: center;
    padding: 20px;
}

#playerContainer {
    width: 100%;
    height: 100%;
    position: relative;
}
#player {
    width: 100%;
    height: 100%;
    border: none;
}

/* Progress bar */
#progressContainer {
    position: absolute;
    bottom: 60px;
    left: 5%;
    width: 90%;
    background: rgba(255,255,255,0.2);
    height: 6px;
    border-radius: 3px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#progressBar {
    height: 100%;
    background: #ff4444;
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

#infoPanel {
    position: absolute;
    top: 20px;
    left: 20px;
    max-width: 60%;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-left: 3px solid #ff4444;
}

/* Seek indikatori */
.seek-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 18px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#seekBackward { left: 30px; }
#seekForward { right: 30px; }

#retryButton {
    background: #ff4444;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
}
</style>

<!-- Asinhrono učitavanje plejera -->
<script src="https://www.youtube.com/iframe_api" async></script>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouTube player...</div>
</div>

<div id="customThumbnail"></div>

<div id="errorScreen">
    <div id="errorText">Greška pri učitavanju YouTube playera</div>
    <div>Proverite internet konekciju</div>
    <button id="retryButton">POKUŠAJ PONOVO</button>
</div>

<div id="playerContainer">
    <div id="player"></div>
</div>

<div id="progressContainer">
    <div id="progressBar"></div>
</div>

<div id="seekBackward" class="seek-indicator">⏪ -10s</div>
<div id="seekForward" class="seek-indicator">+10s ⏩</div>

<div id="infoPanel"></div>

<script>
let player;
let hideTimeout;
let isPlaying = false;
let progressInterval;
let customThumbnail;
let stateCheckInterval;
let hasAdStarted = false;
let hasVideoStarted = false;

/* parametri iz URL-a */
const urlParams = new URLSearchParams(window.location.search);
const videoId   = urlParams.get("videoId");
const subLang   = urlParams.get("subLang") || "auto";
const userLang  = urlParams.get("userLang") || "en";

function onYouTubeIframeAPIReady() {
    initializePlayer();
}

// Forsirana inicijalizacija ako je skripta brža od API ready eventa
if (window.YT && window.YT.Player) {
    onYouTubeIframeAPIReady();
}

function initializePlayer() {
    customThumbnail = document.getElementById("customThumbnail");

    if (!videoId) {
        showError("Nema Video ID-a u URL-u");
        return;
    }

    try {
        player = new YT.Player("player", {
            height: "100%",
            width: "100%",
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                rel: 0,
                modestbranding: 1,
                controls: 0,
                fs: 1,
                iv_load_policy: 3,
                disablekb: 1,
                playsinline: 1,
                cc_load_policy: 1,
                enablejsapi: 1,
                hl: userLang,
                cc_lang_pref: userLang // Forsira tvoj jezik odmah u startu
            },
            events: {
                onReady: onPlayerReady,
                onStateChange: onPlayerStateChange,
                onError: onPlayerError
            }
        });
    } catch (error) {
        showError("Greška pri pokretanju playera");
    }
}

function onPlayerReady() {
    document.getElementById("loadingScreen").style.display = "none";
    showCustomThumbnail();
    hideControls();
    startAdDetection();
    try { player.playVideo(); } catch (e) {}
}

/* Ostatak tvoje logike (nepromenjen) */
function isHolatrt(code) { return code && code.toLowerCase().includes("holatrt"); }

function findTrackByLang(tracks, lang) {
    if (!tracks || !lang) return null;
    const target = lang.toLowerCase();
    let t = tracks.find(tr => tr.languageCode && tr.languageCode.toLowerCase() === target && !isHolatrt(tr.languageCode));
    if (t) return t;
    t = tracks.find(tr => tr.languageCode && tr.languageCode.toLowerCase().startsWith(target + "-") && !isHolatrt(tr.languageCode));
    if (t) return t;
    return tracks.find(tr => tr.languageCode && tr.languageCode.toLowerCase().startsWith(target + "-holatrt"));
}

function pickBestSourceTrack(tracks) {
    if (!tracks || tracks.length === 0) return null;
    let t = tracks.find(tr => tr.languageCode === "en" && !isHolatrt(tr.languageCode));
    if (t) return t;
    t = tracks.find(tr => tr.languageCode && !isHolatrt(tr.languageCode));
    return t || tracks[0];
}

function mapUserLangToEffective(lang, tracks) {
    if (!lang) return lang;
    const L = lang.toLowerCase();
    function has(code) { return !!findTrackByLang(tracks, code); }
    if (L === "sr" || L === "sr-latn" || L === "sr-latn-rs") {
        if (has("sr")) return "sr"; if (has("hr")) return "hr"; if (has("bs")) return "bs"; return "sr";
    }
    if (L === "hr") { if (has("hr")) return "hr"; if (has("bs")) return "bs"; if (has("sr")) return "sr"; return "hr"; }
    return lang;
}

function enableSubs() {
    try {
        if (!player || !player.getOption) return;
        const tracks = player.getOption("captions", "tracklist");
        if (!tracks || tracks.length === 0) return;
        const effectiveUserLang = mapUserLangToEffective(userLang, tracks);
        let userLangTrack = findTrackByLang(tracks, effectiveUserLang);
        if (userLangTrack) {
            player.setOption("captions", "track", { languageCode: userLangTrack.languageCode });
            return;
        }
        let sourceTrack = (subLang && subLang !== "auto") ? findTrackByLang(tracks, subLang) : pickBestSourceTrack(tracks);
        if (sourceTrack) player.setOption("captions", "track", { languageCode: sourceTrack.languageCode });
    } catch (e) {}
}

function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
        hideCustomThumbnail();
        isPlaying = true;
        startProgressTracking();
        detectMainVideoStart();
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        stopProgressTracking();
    } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        showCustomThumbnail();
    }
    resetHideTimer();
}

function detectMainVideoStart() {
    if (!player) return;
    const t = player.getCurrentTime();
    if (!hasVideoStarted && t > 1) {
        hasVideoStarted = true;
        setTimeout(enableSubs, 500); // Brže aktiviranje titlova
    }
}

function startAdDetection() {
    stateCheckInterval = setInterval(function() {
        if (player && player.getPlayerState) {
            const state = player.getPlayerState();
            if (state === YT.PlayerState.UNSTARTED || state === YT.PlayerState.ENDED) showCustomThumbnail();
        }
    }, 500);
}

function showCustomThumbnail() { if (customThumbnail) customThumbnail.style.display = "flex"; }
function hideCustomThumbnail() { if (customThumbnail) customThumbnail.style.display = "none"; }

function startProgressTracking() { stopProgressTracking(); progressInterval = setInterval(updateProgress, 1000); }
function stopProgressTracking() { if (progressInterval) clearInterval(progressInterval); }
function updateProgress() {
    if (player && player.getCurrentTime && player.getDuration) {
        const progress = (player.getCurrentTime() / player.getDuration()) * 100;
        document.getElementById("progressBar").style.width = progress + "%";
    }
}

function seek(direction) {
    if (!player) return;
    player.seekTo(player.getCurrentTime() + (direction * 10), true);
}

function togglePlayPause() {
    if (!player) return;
    if (isPlaying) player.pauseVideo(); else player.playVideo();
}

function volumeChange(delta) {
    if (!player || typeof player.getVolume !== "function") return;
    player.setVolume(Math.max(0, Math.min(100, player.getVolume() + delta)));
}

function showControlsTemporary() {
    document.getElementById("progressContainer").style.opacity = "1";
    resetHideTimer();
}
function hideControls() { document.getElementById("progressContainer").style.opacity = "0"; }
function resetHideTimer() { clearTimeout(hideTimeout); hideTimeout = setTimeout(hideControls, 3000); }

function closePlayer() {
    if (window.AndroidInterface) window.AndroidInterface.closePlayer(); else window.history.back();
}

function showError(message) {
    document.getElementById("loadingScreen").style.display = "none";
    document.getElementById("errorScreen").style.display = "flex";
    document.getElementById("errorText").textContent = message;
}

document.addEventListener("keydown", event => {
    showControlsTemporary();
    switch (event.key) {
        case "ArrowLeft": seek(-1); break;
        case "ArrowRight": seek(1); break;
        case "ArrowUp": volumeChange(+10); break;
        case "ArrowDown": volumeChange(-10); break;
        case "Enter": case " ": togglePlayPause(); break;
        case "Escape": case "Backspace": closePlayer(); break;
    }
});

document.addEventListener("mousemove", showControlsTemporary);
document.getElementById("retryButton").addEventListener("click", () => location.reload());
</script>
</body>
</html>
