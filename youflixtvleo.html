<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TV YouTube Player</title>

<style>
body, html {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
}

/* Loading screen */
#loadingScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
}
#loadingText {
    margin-top: 20px;
    font-size: 18px;
    text-align: center;
}
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #333;
    border-top: 5px solid #ff4444;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* PRAZAN THUMBNAIL — koristiš ga za oglase / buffer */
#customThumbnail {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    opacity: 0;
    z-index: 9998;
    display: none;
}

/* Error screen */
#errorScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    text-align: center;
    padding: 20px;
}

#playerContainer {
    width: 100%;
    height: 100%;
    position: relative;
}
#player {
    width: 100%;
    height: 100%;
    border: none;
}

/* Progress bar */
#progressContainer {
    position: absolute;
    bottom: 60px;
    left: 5%;
    width: 90%;
    background: rgba(255,255,255,0.2);
    height: 6px;
    border-radius: 3px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#progressBar {
    height: 100%;
    background: #ff4444;
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

#infoPanel {
    position: absolute;
    top: 30px;
    left: 30px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-left: 4px solid #ff4444;
}

/* Seek indikatori (ako želiš možeš ih kasnije vratiti u upotrebu) */
.seek-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 18px;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#seekBackward { left: 30px; }
#seekForward { right: 30px; }

#retryButton {
    background: #ff4444;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
}
</style>
</head>

<body>

<!-- Loading -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouTube player...</div>
</div>

<!-- PRAZAN THUMBNAIL -->
<div id="customThumbnail"></div>

<!-- Error -->
<div id="errorScreen">
    <div id="errorText">Greška pri učitavanju YouTube playera</div>
    <div>Proverite internet konekciju</div>
    <button id="retryButton">POKUŠAJ PONOVO</button>
</div>

<!-- Player -->
<div id="playerContainer">
    <div id="player"></div>
</div>

<!-- Progress -->
<div id="progressContainer">
    <div id="progressBar"></div>
</div>

<div id="seekBackward" class="seek-indicator">⏪ -10s</div>
<div id="seekForward" class="seek-indicator">+10s ⏩</div>

<div id="infoPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let hideTimeout;
let isPlaying = false;
let progressInterval;
let customThumbnail;
let stateCheckInterval;
let hasAdStarted = false;
let hasVideoStarted = false;

/* Jezik dolazi iz aplikacije */
const urlParams = new URLSearchParams(window.location.search);
const videoId   = urlParams.get("videoId");
const finalLang = urlParams.get("lang") || "en";      // sistem/srodan
const userLang  = urlParams.get("userLang") || finalLang; // jezik koji korisnik želi

function onYouTubeIframeAPIReady() {
    initializePlayer();
}

function initializePlayer() {
    customThumbnail = document.getElementById("customThumbnail");

    if (!videoId) {
        showError("Nema Video ID-a u URL-u");
        return;
    }

    try {
        player = new YT.Player("player", {
            height: "100%",
            width: "100%",
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                rel: 0,
                modestbranding: 1,
                controls: 0,        // bez YT controls (TV stil)
                showinfo: 0,
                fs: 1,
                iv_load_policy: 3,
                disablekb: 1,
                playsinline: 1,
                cc_load_policy: 1,  // uključi CC
                enablejsapi: 1,
                hl: finalLang       // jezik UI-a
            },
            events: {
                onReady: event => onPlayerReady(event),
                onStateChange: onPlayerStateChange,
                onError: onPlayerError
            }
        });
    } catch (error) {
        showError("Greška pri pokretanju playera");
    }
}

function onPlayerReady(event) {
    document.getElementById("loadingScreen").style.display = "none";
    showCustomThumbnail();
    hideControls();
    startAdDetection();
    showInfo("← / → = -10s / +10s • ENTER = Play/Pause • BACK = zatvori");

    try { player.playVideo(); } catch (e) {}

    enableSubs();
    setTimeout(enableSubs, 1500);
}

/* AUTOMATSKI ODABIR TITLA + AUTO TRANSLATE */
function enableSubs() {
    try {
        const tracks = player.getOption("captions", "tracklist");

        if (!tracks || tracks.length === 0) {
            // nema eksplicitnih titlova → auto captions + auto translate
            player.setOption("captions", "track", { languageCode: "auto" });
            player.setOption("captions", "translationLanguage", {
                languageCode: userLang
            });
            return;
        }

        // 1) probaj userLang (jezik koji je korisnik izabrao u app)
        let selected = tracks.find(t => t.languageCode === userLang);

        // 2) probaj finalLang (sistem/srodan)
        if (!selected) selected = tracks.find(t => t.languageCode === finalLang);

        // 3) engleski
        if (!selected) selected = tracks.find(t => t.languageCode === "en");

        // 4) bilo koji
        if (!selected) selected = tracks[0];

        // postavi pronađeni titl kao izvorni
        player.setOption("captions", "track", {
            languageCode: selected.languageCode
        });

        // uvek pokušaj auto-translate na userLang
        player.setOption("captions", "translationLanguage", {
            languageCode: userLang
        });

    } catch (e) {
        console.log("Subtitle controller error:", e);
    }
}

/* STANJE PLAYERA + REKLAME */
function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
        hideCustomThumbnail();
        isPlaying = true;
        startProgressTracking();
        checkIfAdOrVideo();
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        stopProgressTracking();
    } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        stopProgressTracking();
        showCustomThumbnail();
        hasVideoStarted = false;
        hasAdStarted = false;
        showInfo("Video završen");
    } else if (event.data === YT.PlayerState.BUFFERING) {
        setTimeout(checkBuffering, 2000);
    } else if (event.data === YT.PlayerState.UNSTARTED) {
        showCustomThumbnail();
    }

    resetHideTimer();
}

function checkIfAdOrVideo() {
    if (!player) return;
    const currentTime = player.getCurrentTime();
    if (currentTime === 0 && !hasVideoStarted) hasAdStarted = true;
    else hasVideoStarted = true;
}

function checkBuffering() {
    if (player && player.getPlayerState() === YT.PlayerState.BUFFERING)
        showCustomThumbnail();
}

function startAdDetection() {
    stateCheckInterval = setInterval(function() {
        if (player && player.getPlayerState && player.getCurrentTime) {
            const state = player.getPlayerState();
            const currentTime = player.getCurrentTime();
            if (state === YT.PlayerState.PAUSED && currentTime < 2 && hasAdStarted)
                showCustomThumbnail();
            if (state === YT.PlayerState.BUFFERING && currentTime < 2 && hasAdStarted)
                showCustomThumbnail();
            if (state === YT.PlayerState.UNSTARTED) showCustomThumbnail();
            if (state === YT.PlayerState.ENDED) showCustomThumbnail();
        }
    }, 500);
}

function stopAdDetection() {
    if (stateCheckInterval) clearInterval(stateCheckInterval);
}

function onPlayerError(event) {
    showError("YouTube greška: " + event.data);
}

/* THUMBNAIL overlay */
function showCustomThumbnail() {
    if (customThumbnail && customThumbnail.style.display === "none")
        customThumbnail.style.display = "flex";
}
function hideCustomThumbnail() {
    if (customThumbnail && customThumbnail.style.display !== "none")
        customThumbnail.style.display = "none";
}

/* PROGRESS BAR */
function startProgressTracking() {
    stopProgressTracking();
    progressInterval = setInterval(updateProgress, 1000);
}
function stopProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}
function updateProgress() {
    if (player && player.getCurrentTime && player.getDuration) {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();
        const progress = (currentTime / duration) * 100;
        document.getElementById("progressBar").style.width = progress + "%";
    }
}

/* SEEK + PLAY/PAUSE */
function seek(direction) {
    if (!player) return;
    const seekAmount = 10; // 10 sekundi
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration();
    const newTime = Math.max(0, Math.min(duration, currentTime + (direction * seekAmount)));
    player.seekTo(newTime, true);

    // kratki overlay možeš aktivirati ovde ako želiš (seekBackward/seekForward)
}

function togglePlayPause() {
    if (!player) return;
    if (isPlaying) player.pauseVideo();
    else player.playVideo();
}

/* CONTROLS overlay */
function showControls() {
    document.getElementById("progressContainer").style.opacity = "1";
    resetHideTimer();
}
function hideControls() {
    document.getElementById("progressContainer").style.opacity = "0";
    clearTimeout(hideTimeout);
}
function showControlsTemporary() {
    showControls();
    resetHideTimer();
}
function resetHideTimer() {
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(hideControls, 3000);
}

/* ZATVARANJE PLAYERA */
function closePlayer() {
    stopProgressTracking();
    stopAdDetection();
    if (window.AndroidInterface && typeof AndroidInterface.closePlayer === "function") {
        AndroidInterface.closePlayer();
    } else {
        window.history.back();
    }
}

/* INFO PANEL */
function showInfo(message) {
    const infoPanel = document.getElementById("infoPanel");
    infoPanel.textContent = message;
    infoPanel.style.opacity = "1";
    setTimeout(() => infoPanel.style.opacity = "0", 3000);
}

/* ERROR HANDLING */
function showError(message) {
    document.getElementById("loadingScreen").style.display = "none";
    const e = document.getElementById("errorScreen");
    e.style.display = "flex";
    document.getElementById("errorText").textContent = message;
}
function retryPlayer() {
    document.getElementById("errorScreen").style.display = "none";
    document.getElementById("loadingScreen").style.display = "flex";
    initializePlayer();
}

/* DPAD / tastatura navigacija (WebView) */
document.addEventListener("keydown", event => {
    showControlsTemporary();

    switch (event.key) {
        case "ArrowLeft":
            seek(-1);
            event.preventDefault();
            break;
        case "ArrowRight":
            seek(1);
            event.preventDefault();
            break;
        case "Enter":
        case " ":
            togglePlayPause();
            event.preventDefault();
            break;
        case "Escape":
        case "Backspace":
            try { if (player) player.pauseVideo(); } catch (e) {}
            closePlayer();
            event.preventDefault();
            break;
    }
});

document.addEventListener("mousemove", showControlsTemporary);
document.addEventListener("click", showControlsTemporary);

document.getElementById("retryButton").addEventListener("click", retryPlayer);

window.addEventListener("load", () => setTimeout(hideControls, 2000));
window.addEventListener("beforeunload", () => stopProgressTracking());
</script>

</body>
</html>
