<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouFlix Player</title>

<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: black;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }

    #player {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
    }

    #loadingScreen {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 9999;
        color: white;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #444;
        border-top: 5px solid red;
        border-radius: 50%;
        animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg);}
        100% { transform: rotate(360deg);}
    }

    #toast {
        position: absolute;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 12px;
        background: rgba(30,30,30,0.85);
        color: #fff;
        font-size: 18px;
        opacity: 0;
        transition: opacity .4s;
        z-index: 999999;
    }
</style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div style="margin-top:20px;font-size:18px;">Učitavam video...</div>
</div>

<div id="toast"></div>

<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   PARAMETRI IZ ANDROID-A
============================================================ */
const params = new URLSearchParams(window.location.search);
const VIDEO_ID = params.get("videoId");
const USER_LANG = params.get("lang") || "en";

/* ============================================================
   AUTOMATSKI SUBTITLE FALLBACK — originalna logika
============================================================ */
function chooseSubtitle(available, lang) {

    // 1) direktan pogodak
    if (available.includes(lang))
        return lang;

    // 2) sr/hr/bs fallback
    const SR = ["sr","hr","bs","me"];
    if (SR.includes(lang)) {
        for (let l of SR) {
            if (available.includes(l)) return l;
        }
    }

    // 3) cs/sk fallback
    const SK = ["sk","cs"];
    if (SK.includes(lang)) {
        for (let l of SK) if (available.includes(l)) return l;
    }

    // 4) ako postoji engleski → auto translate
    if (available.includes("en"))
        return "auto-en";

    // 5) ništa
    return null;
}

/* ============================================================
   PLAYER
============================================================ */
let player = null;

function onYouTubeIframeAPIReady() {

    player = new YT.Player("player", {
        videoId: VIDEO_ID,
        width: "100%",
        height: "100%",
        playerVars: {
            autoplay: 1,
            controls: 1,
            rel: 0,
            fs: 1,
            hl: USER_LANG,
            cc_load_policy: 1,
            iv_load_policy: 3
        },
        events: {
            onReady: onPlayerReady
        }
    });
}

/* ============================================================
   AUTO TITLOVI — originalni sistem
============================================================ */
function onPlayerReady() {
    setTimeout(() => {

        let tracks = [];
        try {
            tracks = player.getOption("captions","tracklist") || [];
        } catch(e){}

        let langs = tracks.map(t => t.languageCode);

        let chosen = chooseSubtitle(langs, USER_LANG);

        if (!chosen) {
            toast("Nema dostupnih titlova");
        }
        else if (chosen === "auto-en") {
            player.setOption("captions","track",{languageCode:"en"});
            player.setOption("captions","translate", USER_LANG);
            toast("Auto prevod → " + USER_LANG.toUpperCase());
        }
        else {
            player.setOption("captions","track",{languageCode: chosen});
            toast("Titl: " + chosen.toUpperCase());
        }

        document.getElementById("loadingScreen").style.display = "none";

    }, 800);
}

/* ============================================================
   DPAD KONTROLE — originalne, provereno funkcionalne
============================================================ */
document.addEventListener("keydown", e => {

    if (!player) return;

    switch (e.key) {

        case "ArrowLeft":
            try {
                player.seekTo(Math.max(0, player.getCurrentTime() - 20), true);
            } catch(e){}
            e.preventDefault();
            break;

        case "ArrowRight":
            try {
                player.seekTo(player.getCurrentTime() + 20, true);
            } catch(e){}
            e.preventDefault();
            break;

        case "Enter":
            try {
                let s = player.getPlayerState();
                if (s === 1) player.pauseVideo();
                else player.playVideo();
            } catch(e){}
            e.preventDefault();
            break;

        case "ArrowDown":
            // aktivira YouTube kontrole
            try {
                player.getIframe().contentWindow.postMessage(
                    JSON.stringify({event:"command",func:"showControls",args:[true]}),"*"
                );
            } catch(e){}
            e.preventDefault();
            break;

        case "ArrowUp":
            // UP → YouTube titl meni (default)
            try {
                player.getIframe().contentWindow.postMessage(
                    JSON.stringify({event:"command",func:"showControls",args:[true]}),"*"
                );
            } catch(e){}
            e.preventDefault();
            break;
    }
});

/* ============================================================
   TOAST
============================================================ */
let toastTimer = null;
function toast(msg){
    const t = document.getElementById("toast");
    t.innerHTML = msg;
    t.style.opacity = 1;

    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.style.opacity = 0, 2500);
}
</script>

</body>
</html>
