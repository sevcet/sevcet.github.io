<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouFlix Player</title>

<style>
    html, body {
        margin:0; padding:0;
        width:100%; height:100%;
        background:#000;
        overflow:hidden;
    }

    #player {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
    }

    #loading {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        background:black;
        color:white;
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        z-index:9999;
        font-family:Arial;
    }
</style>
</head>

<body>

<div id="loading">
    <div style="border:5px solid #444;border-top:5px solid red;width:50px;height:50px;border-radius:50%;animation:spin 1s linear infinite;"></div>
    <div style="margin-top:20px;font-size:18px;">Loading...</div>
</div>

<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   URL PARAMS
============================================================ */
const params = new URLSearchParams(window.location.search);
const VIDEO_ID = params.get("videoId");
const USER_LANG = (params.get("lang") || "en").toLowerCase();

/* ============================================================
   RELATED FALLBACK
============================================================ */
const RELATED = {
    "sr":["hr","bs","me"],
    "bs":["sr","hr","me"],
    "hr":["sr","bs","me"],

    "sk":["cs"], "cs":["sk"],
    "sl":["hr","sr"],
    "pl":["cs","sk"],

    "da":["sv","no"], "sv":["da","no","is"],
    "no":["sv","da"], "is":["sv"],

    "mk":["bg","sr"], "bg":["mk","sr"],

    "uk":["ru"], "ru":["uk"],

    "fr":["es","it","pt"],
    "es":["fr","pt","it"],
    "pt":["es","fr","it"],
    "it":["es","fr","pt"],

    "zh":["ja","ko"], "ja":["zh","ko"], "ko":["zh","ja"]
};

/* ============================================================
   PICK SUBTITLE
============================================================ */
function pickSub(available, lang) {

    // direct
    if (available.includes(lang)) return lang;

    // related
    if (RELATED[lang]) {
        for (let r of RELATED[lang]) {
            if (available.includes(r)) return r;
        }
    }

    // auto translate fallback
    if (available.includes("en")) return "auto-en";

    return null;
}

/* ============================================================
   YOUTUBE API
============================================================ */
let player;
let subs = [];
let videoStarted = false;

function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        videoId: VIDEO_ID,
        width:"100%", height:"100%",
        playerVars:{
            autoplay:1,
            controls:1,
            cc_load_policy:1,
            rel:0,
            fs:1,
            iv_load_policy:3,
            hl:USER_LANG
        },
        events:{
            onReady:()=>{},
            onStateChange:onStateChange
        }
    });
}

function onStateChange(e){
    // state 1 = play
    if (e.data === 1 && !videoStarted) {
        videoStarted = true;
        applySubtitles();
    }
}

/* ============================================================
   APPLY SUBTITLES
============================================================ */
function applySubtitles(){

    let tracklist = [];

    try {
        tracklist = player.getOption("captions","tracklist") || [];
    }catch(e){}

    subs = tracklist.map(t => t.languageCode.toLowerCase());

    const chosen = pickSub(subs, USER_LANG);

    if (chosen === "auto-en") {
        player.setOption("captions","track",{languageCode:"en"});
        player.setOption("captions","translate", USER_LANG);
    }
    else if (chosen) {
        player.setOption("captions","track",{languageCode: chosen});
    }

    document.getElementById("loading").style.display = "none";
}
</script>

</body>
</html>
