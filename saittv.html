<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouFlix Player</title>

<style>
    html, body {
        margin:0; padding:0;
        width:100%; height:100%;
        background:#000;
        overflow:hidden;
        font-family:Arial, sans-serif;
    }

    #player {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
    }

    #loading {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        background:black;
        color:white;
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        z-index:9999;
    }

    #subtitleMenu {
        position:absolute;
        top:120px;
        right:120px;
        width:380px;
        max-height:55%;
        overflow-y:auto;
        background:rgba(0,0,0,0.90);
        border:2px solid #fff;
        border-radius:12px;
        padding:12px;
        color:white;
        display:none;
        z-index:999999;
    }

    .menuItem {
        padding:12px;
        background:#222;
        border-radius:6px;
        margin-bottom:6px;
        font-size:18px;
    }
    .menuItem.focused {
        background:#555;
        border:2px solid #fff;
    }

    #toast {
        position:absolute;
        top:40px;
        left:50%;
        transform:translateX(-50%);
        background:rgba(20,20,20,0.85);
        padding:12px 24px;
        border-radius:10px;
        color:white;
        opacity:0;
        transition:opacity .4s;
        z-index:99999;
        font-size:18px;
    }
</style>
</head>

<body>

<div id="loading">
    <div style="border:5px solid #444;border-top:5px solid red;width:50px;height:50px;border-radius:50%;animation:spin 1s linear infinite;"></div>
    <div style="margin-top:20px;font-size:18px;">Loading...</div>
</div>

<div id="toast"></div>
<div id="subtitleMenu"></div>
<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   PARAMS
============================================================ */
const params = new URLSearchParams(window.location.search);
const VIDEO_ID = params.get("videoId");
const USER_LANG = (params.get("lang") || "en").toLowerCase();

/* ============================================================
   FULL ENGLISH LANGUAGE NAMES
============================================================ */
const LANG_NAMES = {
    "en":"English",
    "sr":"Serbian",
    "bs":"Bosnian",
    "hr":"Croatian",
    "me":"Montenegrin",
    "mk":"Macedonian",
    "sl":"Slovenian",
    "sq":"Albanian",
    "bg":"Bulgarian",
    "ro":"Romanian",
    "hu":"Hungarian",
    "fr":"French",
    "de":"German",
    "es":"Spanish",
    "it":"Italian",
    "pt":"Portuguese",
    "nl":"Dutch",
    "pl":"Polish",
    "cs":"Czech",
    "sk":"Slovak",
    "da":"Danish",
    "sv":"Swedish",
    "fi":"Finnish",
    "no":"Norwegian",
    "is":"Icelandic",
    "et":"Estonian",
    "lv":"Latvian",
    "lt":"Lithuanian",
    "uk":"Ukrainian",
    "ru":"Russian",
    "tr":"Turkish",
    "el":"Greek",
    "ar":"Arabic",
    "fa":"Persian",
    "hi":"Hindi",
    "bn":"Bengali",
    "zh":"Chinese",
    "ja":"Japanese",
    "ko":"Korean",
    "vi":"Vietnamese",
    "id":"Indonesian",
    "ms":"Malay",
    "th":"Thai"
};

/* ============================================================
   RELATED fallback
============================================================ */
const RELATED = {
    "sr":["bs","hr"],
    "bs":["sr","hr"],
    "hr":["sr","bs"],
    "sk":["cs"],
    "cs":["sk"],
    "sl":["hr","sr"],
    "pl":["cs","sk"],
    "da":["sv","no"],
    "sv":["da","no","is"],
    "no":["sv","da"],
    "is":["sv"],
    "mk":["bg","sr"],
    "bg":["mk","sr"],
    "uk":["ru"],
    "ru":["uk"],
    "fr":["es","it","pt"],
    "es":["fr","pt","it"],
    "pt":["es","fr","it"],
    "it":["es","fr","pt"],
    "zh":["ja","ko"],
    "ja":["zh","ko"],
    "ko":["zh","ja"]
};

/* ============================================================
   AUTO SELECT SUBTITLE
============================================================ */
function pickSub(available, lang){
    if (available.includes(lang)) return lang;
    if (RELATED[lang]) {
        for (let r of RELATED[lang]) {
            if (available.includes(r)) return r;
        }
    }
    if (available.includes("en")) return "auto-en";
    return null;
}

/* ============================================================
   YOUTUBE
============================================================ */
let player, availableSubs=[];
let realVideoStarted=false;

function onYouTubeIframeAPIReady(){
    player = new YT.Player("player", {
        videoId:VIDEO_ID,
        width:"100%", height:"100%",
        playerVars:{
            autoplay:1, controls:1,
            cc_load_policy:1, fs:1, rel:0,
            iv_load_policy:3, hl:USER_LANG
        },
        events:{
            onReady:onReady,
            onStateChange:onStateChange
        }
    });
}

function onReady(){}

function onStateChange(e){
    if (e.data === 1 && !realVideoStarted){
        realVideoStarted = true;
        applyInitialSubtitles();
    }
}

function applyInitialSubtitles(){

    let tracks=[];
    try{
        tracks = player.getOption("captions","tracklist") || [];
    }catch(e){}

    availableSubs = tracks.map(t=>t.languageCode.toLowerCase());

    const chosen = pickSub(availableSubs, USER_LANG);

    if (chosen === "auto-en"){
        player.setOption("captions","track",{languageCode:"en"});
        player.setOption("captions","translate",USER_LANG);
    }
    else if (chosen){
        player.setOption("captions","track",{languageCode:chosen});
    }

    document.getElementById("loading").style.display="none";
    toast("Subtitle: " + (LANG_NAMES[chosen] || chosen).toUpperCase());
}

/* ============================================================
   SUBTITLE MENU (WITH AUTO SCROLL)
============================================================ */
let menuOpen=false;
let menuIndex=0;

function openSubtitleMenu(){
    const menu=document.getElementById("subtitleMenu");
    menu.innerHTML="";

    availableSubs.forEach(l=>{
        let name = LANG_NAMES[l] || l.toUpperCase();
        menu.innerHTML += `<div class="menuItem" data-lang="${l}">${name}</div>`;
    });

    if (availableSubs.length===0){
        menu.innerHTML = `<div class="menuItem">No subtitles available</div>`;
    }

    menu.style.display="block";
    menuOpen=true;
    menuIndex=0;
    updateFocus();
}

function closeSubtitleMenu(){
    document.getElementById("subtitleMenu").style.display="none";
    menuOpen=false;
}

function updateFocus(){
    const items = document.querySelectorAll(".menuItem");
    items.forEach(i=>i.classList.remove("focused"));

    if (!items[menuIndex]) return;

    const el = items[menuIndex];
    el.classList.add("focused");

    el.scrollIntoView({block:"center",behavior:"smooth"});
}

function activateItem(){
    const items = document.querySelectorAll(".menuItem");
    const sel = items[menuIndex];
    if (!sel) return;

    const lang = sel.getAttribute("data-lang");
    if (lang){
        player.setOption("captions","track",{languageCode:lang});
        toast("Subtitle: " + (LANG_NAMES[lang]||lang).toUpperCase());
    }
    closeSubtitleMenu();
}

/* ============================================================
   DPAD
============================================================ */
document.addEventListener("keydown", e=>{

    if(menuOpen){

        const max = availableSubs.length - 1;

        if(e.key==="ArrowDown"){
            menuIndex = Math.min(menuIndex+1, max);
            updateFocus();
            e.preventDefault();
            return;
        }
        if(e.key==="ArrowUp"){
            menuIndex = Math.max(menuIndex-1, 0);
            updateFocus();
            e.preventDefault();
            return;
        }

        if(e.key==="Enter"){
            activateItem();
            e.preventDefault();
            return;
        }

        if(["Escape","Backspace","Back"].includes(e.key)){
            closeSubtitleMenu();
            return;
        }
    }

    switch(e.key){
        case "ArrowUp":
            openSubtitleMenu();
            e.preventDefault();
            break;

        case "ArrowLeft":
            player.seekTo(player.getCurrentTime()-20,true);
            e.preventDefault();
            break;

        case "ArrowRight":
            player.seekTo(player.getCurrentTime()+20,true);
            e.preventDefault();
            break;

        case "Enter":
            let s = player.getPlayerState();
            if(s===1) player.pauseVideo();
            else player.playVideo();
            e.preventDefault();
            break;
    }
});

/* ============================================================
   TOAST
============================================================ */
let tmr=null;
function toast(msg){
    const t=document.getElementById("toast");
    t.innerHTML=msg;
    t.style.opacity=1;
    clearTimeout(tmr);
    tmr=setTimeout(()=>t.style.opacity=0,2500);
}
</script>

</body>
</html>
