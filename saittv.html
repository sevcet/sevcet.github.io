<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        /* Loading Screen */
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #playerContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        /* Debug panel */
        #debugPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            color: #0f0;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 60%;
            max-height: 30%;
            overflow-y: auto;
            display: none;
            z-index: 10000;
        }

        /* Toast */
        #toastBox {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20,20,20,0.95);
            color: white;
            padding: 14px 26px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 100000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        /* MINI INFO OVERLAY (Smart TV Style) */
        #infoOverlay {
            position: absolute;
            top: 60px;
            left: 60px;
            background: rgba(0,0,0,0.68);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            display: none;
            z-index: 90000;
            width: 420px;
            animation: fadeIn 0.3s ease-out;
        }

        #infoOverlay h2 {
            margin: 0;
            font-size: 22px;
            font-weight: bold;
        }

        #infoOverlay p {
            margin: 6px 0;
            font-size: 16px;
        }

        #infoIcons {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.8;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<!-- MINI INFO OVERLAY -->
<div id="infoOverlay">
    <h2 id="infoTitle">–</h2>
    <p id="infoChannel">–</p>
    <p id="infoViews">–</p>
    <div id="infoIcons">CC | Audio | Quality</div>
</div>

<div id="playerContainer">
    <div id="player"></div>
</div>

<div id="debugPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   URL PARAMS
============================================================ */
const P = new URLSearchParams(window.location.search);
const VIDEO_ID = P.get("videoId") || null;
const SYS_LANG = P.get("sys") || "en";
const USER_LANG = P.get("lang") || SYS_LANG;
const DEBUG = P.get("debug") === "1";

/* ============================================================
   DEBUG LOGGING
============================================================ */
function log(msg){
    if(!DEBUG) return;
    const box=document.getElementById("debugPanel");
    box.style.display="block";
    box.innerHTML+=msg+"<br>";
}

/* ============================================================
   MINI INFO OVERLAY (SMART TV)
============================================================ */
let infoTimeout = null;

function showInfoOverlay(){
    const box = document.getElementById("infoOverlay");
    box.style.display = "block";

    if(infoTimeout) clearTimeout(infoTimeout);
    infoTimeout = setTimeout(()=> box.style.display="none", 5000);
}

/* ============================================================
   FETCH VIDEO METADATA (title, channel, views)
============================================================ */
async function loadVideoInfo(){
    try{
        let r = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${VIDEO_ID}`);
        let j = await r.json();

        document.getElementById("infoTitle").innerText = j.title || "Video";
        document.getElementById("infoChannel").innerText = j.author_name || "Unknown channel";
        document.getElementById("infoViews").innerText = j.author_url ? "" : "";
    }catch(e){
        log("INFO LOAD ERROR: "+e);
    }
}

/* ============================================================
   TITLOVI — FALLBACK SISTEM
============================================================ */
const RELATED = {
    "sr": ["bs","hr","me"],
    "bs": ["sr","hr","me"],
    "hr": ["sr","bs","me"],
    "me": ["sr","bs","hr"],
    "sk": ["cs"],
    "cs": ["sk"]
};

function pickSubtitle(available){
    log("Available: "+available.join(", "));

    // 1. User-chosen
    if(available.includes(USER_LANG)){
        log("Using USER_LANG: "+USER_LANG);
        return USER_LANG;
    }
    // 2. System language
    if(available.includes(SYS_LANG)){
        log("Using SYS_LANG: "+SYS_LANG);
        return SYS_LANG;
    }
    // 3. Related
    if(RELATED[SYS_LANG]){
        for(let r of RELATED[SYS_LANG]){
            if(available.includes(r)){
                log("Using related: "+r);
                return r;
            }
        }
    }
    // 4. Auto translate from English
    if(available.includes("en")){
        log("Using auto-translate from English → "+USER_LANG);
        return "auto-en";
    }

    // 5. No subtitles
    log("NO subtitles available");
    return null;
}

/* ============================================================
   YT PLAYER INIT
============================================================ */
let player=null;
let longPressTimeout=null;

function onYouTubeIframeAPIReady(){
    loadVideoInfo();

    player=new YT.Player("player",{
        height:"100%",width:"100%",
        videoId:VIDEO_ID,
        playerVars:{
            autoplay:1,
            controls:1,
            fs:1,
            rel:0,
            cc_load_policy:1,
            hl:SYS_LANG
        },
        events:{
            onReady:onReady
        }
    });
}

function onReady(){
    setTimeout(()=>{
        let tracks = player.getOption("captions","tracklist") || [];
        let available = tracks.map(t=>t.languageCode);

        let chosen = pickSubtitle(available);

        if(chosen===null){
            log("Subtitles OFF");
        }
        else if(chosen==="auto-en"){
            player.setOption("captions","track",{languageCode:"en"});
            player.setOption("captions","translate",USER_LANG);
        }
        else{
            player.setOption("captions","track",{languageCode:chosen});
        }

        hideLoading();

    },800);
}

/* ============================================================
   HIDING LOADING
============================================================ */
function hideLoading(){
    const e=document.getElementById("loadingScreen");
    if(e) e.style.display="none";
}

/* ============================================================
   TOAST
============================================================ */
let toastTimeout=null;

function toast(msg){
    const box=document.getElementById("toastBox");
    box.innerText=msg;
    box.style.opacity=1;

    if(toastTimeout) clearTimeout(toastTimeout);
    toastTimeout=setTimeout(()=>box.style.opacity=0,2500);
}

/* ============================================================
   STATS FOR NERDS
============================================================ */
function openStats(){
    try{
        player.getIframe().contentWindow.postMessage(
            JSON.stringify({event:"command",func:"showVideoStats"}),"*"
        );
    }catch(e){}
}

/* ============================================================
   REMOTE CONTROL
============================================================ */
document.addEventListener("keydown", e => {

    switch(e.key){

        case "ArrowLeft":
            player.seekTo(player.getCurrentTime()-20,true);
            toast("-20 sek");
            e.preventDefault();
        break;

        case "ArrowRight":
            player.seekTo(player.getCurrentTime()+20,true);
            toast("+20 sek");
            e.preventDefault();
        break;

        case "Enter":
        case "OK":
            let state = player.getPlayerState();
            if(state===1) player.pauseVideo();
            else player.playVideo();
            toast("Play/Pause");
            e.preventDefault();
        break;

        case "ArrowUp":
            // short press → mini info
            if(longPressTimeout) clearTimeout(longPressTimeout);

            longPressTimeout = setTimeout(()=>{
                openStats();  // long press
                toast("Stats for nerds");
            }, 550); // long press threshold

            // short press → show overlay
            setTimeout(()=>{
                if(!e.repeat){
                    showInfoOverlay();
                }
            },120);

            e.preventDefault();
        break;

        case "ArrowDown":
            // YouTube handles default controls
        break;
    }
});

/* STOP LONG PRESS IF KEY RELEASED */
document.addEventListener("keyup", e => {
    if(e.key==="ArrowUp" && longPressTimeout){
        clearTimeout(longPressTimeout);
    }
});

</script>

</body>
</html>
