<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid red;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

        #toastBox {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20,20,20,0.9);
            padding: 12px 24px;
            border-radius: 10px;
            color: white;
            opacity: 0;
            font-size: 18px;
            z-index: 99999;
            transition: opacity 0.4s ease;
        }

        /* Popup meni */
        #subtitleMenu, #audioMenu {
            position: absolute;
            top: 80px;
            right: 80px;
            width: 360px;
            max-height: 65%;
            overflow-y: auto;
            background: rgba(0,0,0,0.85);
            border: 2px solid white;
            border-radius: 12px;
            padding: 15px;
            color: white;
            display: none;
            z-index: 99999;
        }

        .menuTitle {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .menuItem {
            padding: 10px;
            margin: 5px 0;
            background: #222;
            border-radius: 6px;
            cursor: pointer;
        }

        .menuItem:hover {
            background: #444;
        }

        #player {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div style="margin-top:20px;font-size:18px;">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<div id="player"></div>

<div id="subtitleMenu"></div>
<div id="audioMenu"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ================================================================
   PARAMETRI IZ ANDROID PlayerActivity
================================================================ */
const params = new URLSearchParams(window.location.search);
const VIDEO_ID = params.get("videoId");
const USER_LANG = params.get("lang") || "en";
const XML_URL   = params.get("xml");  // NOVI PARAMETAR

if (!VIDEO_ID || !XML_URL) {
    alert("Missing parameters videoId/xml");
}

/* ================================================================
   43 PODRŽANA JEZIKA
================================================================ */
const SUPPORTED = [
    "sr","bs","hr","me",
    "mk","sl","sq","bg","ro","hu",
    "en","de","fr","es","it","pt",
    "nl","pl","cs","sk","da","sv","fi","no","is",
    "et","lv","lt","uk","ru","tr","el",
    "ar","fa","hi","bn",
    "zh","ja","ko","vi","id","ms","th"
];

/* ================================================================
   RELATED GRUPE (tvoj zahtev)
================================================================ */
const RELATED = {
    "sr": ["bs","hr","me"],
    "bs": ["sr","hr","me"],
    "hr": ["sr","bs","me"],
    "me": ["sr","bs","hr"],

    "sk": ["cs"],
    "cs": ["sk"],
    "sl": ["hr","sr"],
    "pl": ["cs","sk"],

    "da": ["sv","no"],
    "sv": ["da","no","is"],
    "no": ["sv","da"],
    "is": ["sv"],

    "mk": ["bg","sr"],
    "bg": ["mk","sr"],

    "uk": ["ru"],
    "ru": ["uk"],

    "tr": ["az"],

    "fr": ["es","it","pt"],
    "es": ["fr","pt","it"],
    "pt": ["es","fr","it"],
    "it": ["es","fr","pt"],

    "zh": ["ja","ko"],
    "ja": ["zh","ko"],
    "ko": ["zh","ja"]
};

/* ================================================================
   GLOBALNE LISTE IZ XML-a
================================================================ */
let xmlSubs = [];
let xmlAudio = [];

/* ================================================================
   UČITAVANJE XML-a I PRONAĐI VIDEO
================================================================ */
function loadXML() {
    return fetch(XML_URL)
        .then(r => r.text())
        .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
        .then(xml => {
            const movies = [...xml.getElementsByTagName("movie")];

            for (let m of movies) {
                let vid = m.getElementsByTagName("videoId")[0]?.textContent.trim();

                if (vid === VIDEO_ID) {
                    xmlSubs = [...m.getElementsByTagName("available_subtitles")[0].getElementsByTagName("sub")]
                             .map(s => s.textContent.trim());

                    xmlAudio = [...m.getElementsByTagName("available_audio")[0].getElementsByTagName("audio")]
                             .map(a => a.textContent.trim());

                    return true;
                }
            }
            return false;
        })
        .catch(err => {
            console.error("XML ERROR:", err);
            return false;
        });
}

/* ================================================================
   AUTO-PICK SUBTITLE (XML primary)
================================================================ */
function chooseSubtitle() {
    const lang = USER_LANG;

    // 1 — Direct match
    if (xmlSubs.includes(lang)) return lang;

    // 2 — Related
    if (RELATED[lang]) {
        for (let r of RELATED[lang]) {
            if (xmlSubs.includes(r)) return r;
        }
    }

    // 3 — Auto translate EN -> USER_LANG
    if (xmlSubs.includes("en")) return "auto-en";

    // 4 — No subs
    return null;
}

/* ================================================================
   YOUTUBE PLAYER
================================================================ */
let player = null;

function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        videoId: VIDEO_ID,
        width: "100%",
        height: "100%",
        playerVars: {
            autoplay: 1,
            controls: 1,
            fs: 1,
            cc_load_policy: 1,
            iv_load_policy: 3,
            rel: 0
        },
        events: {
            onReady: applySubtitle
        }
    });
}

function applySubtitle() {
    const choice = chooseSubtitle();

    if (!choice) {
        toast("Nema titlova");
        hideLoading();
        return;
    }

    if (choice === "auto-en") {
        player.setOption("captions", "track", { languageCode: "en" });
        player.setOption("captions", "translate", USER_LANG);
        toast("Auto → " + USER_LANG);
    } else {
        player.setOption("captions", "track", { languageCode: choice });
        toast("Titl: " + choice);
    }

    hideLoading();
}

/* ================================================================
   SUBTITLE MENU (UP)
================================================================ */
function openSubtitleMenu() {
    const menu = document.getElementById("subtitleMenu");
    let html = `<div class='menuTitle'>Titlovi</div>`;

    xmlSubs.forEach(s => {
        html += `<div class='menuItem' onclick='setSub("${s}")'>${s}</div>`;
    });

    html += `<div class='menuTitle' style='margin-top:10px;'>Auto Translate</div>`;
    SUPPORTED.forEach(s => {
        html += `<div class='menuItem' onclick='autoTranslate("${s}")'>auto → ${s}</div>`;
    });

    html += `<div class='menuItem' onclick='subOff()'>Isključi titlove</div>`;

    menu.innerHTML = html;
    menu.style.display = "block";
}

function setSub(lang) {
    player.setOption("captions", "track", { languageCode: lang });
    toast("Titl: " + lang);
    closeMenus();
}

function autoTranslate(lang) {
    player.setOption("captions", "track", { languageCode: "en" });
    player.setOption("captions", "translate", lang);
    toast("Auto → " + lang);
    closeMenus();
}

function subOff() {
    player.setOption("captions", "track", {});
    toast("Titlovi off");
    closeMenus();
}

/* ================================================================
   AUDIO MENU (DOWN)
================================================================ */
function openAudioMenu() {
    const menu = document.getElementById("audioMenu");
    let html = `<div class='menuTitle'>Audio</div>`;

    xmlAudio.forEach(a => {
        html += `<div class='menuItem' onclick='setAudio("${a}")'>${a}</div>`;
    });

    menu.innerHTML = html;
    menu.style.display = "block";
}

function setAudio(track) {
    player.setOption("captions", "audioTrack", track);
    toast("Audio: " + track);
    closeMenus();
}

/* ================================================================
   DPAD REMOTE
================================================================ */
document.addEventListener("keydown", e => {
    switch (e.key) {
        case "ArrowLeft":
            player.seekTo(Math.max(0, player.getCurrentTime() - 20), true);
            e.preventDefault();
            break;

        case "ArrowRight":
            player.seekTo(player.getCurrentTime() + 20, true);
            e.preventDefault();
            break;

        case "Enter":
            let s = player.getPlayerState();
            if (s === 1) player.pauseVideo();
            else player.playVideo();
            e.preventDefault();
            break;

        case "ArrowUp":
            closeMenus();
            openSubtitleMenu();
            e.preventDefault();
            break;

        case "ArrowDown":
            closeMenus();
            openAudioMenu();
            e.preventDefault();
            break;
    }
});

function closeMenus() {
    document.getElementById("subtitleMenu").style.display = "none";
    document.getElementById("audioMenu").style.display = "none";
}

/* ================================================================
   HELPERS
================================================================ */
function hideLoading() {
    document.getElementById("loadingScreen").style.display = "none";
}

let toastTimer = null;
function toast(msg) {
    const box = document.getElementById("toastBox");
    box.innerHTML = msg;
    box.style.opacity = 1;

    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
        box.style.opacity = 0;
    }, 2500);
}

/* ================================================================
   START
================================================================ */
loadXML().then(ok => {
    if (!ok) {
        toast("XML error");
        hideLoading();
    }
});
</script>

</body>
</html>
