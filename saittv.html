<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        /* Loading Screen */
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            margin-top: 20px;
            font-size: 18px;
        }

        /* Player Container */
        #playerContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        /* Debug Panel */
        #debugPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            color: #0f0;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 60%;
            max-height: 30%;
            overflow-y: auto;
            display: none; /* default hidden */
            z-index: 100000;
        }

        /* Message Toast */
        #toastBox {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20,20,20,0.9);
            color: white;
            padding: 14px 26px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 100000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<div id="playerContainer">
    <div id="player"></div>
</div>

<div id="debugPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   ANDROID → HTML parametri
============================================================ */
const urlParams = new URLSearchParams(window.location.search);

const VIDEO_ID = urlParams.get("videoId") || null;
const SYSTEM_LANG = urlParams.get("sys") || "en";  // jezik sistema (npr: sr)
const USER_LANG = urlParams.get("lang") || SYSTEM_LANG; // korisnički izbor kada dodamo meni
const DEBUG_ENABLED = urlParams.get("debug") === "1";

logDebug("Video ID: " + VIDEO_ID);
logDebug("System Language: " + SYSTEM_LANG);
logDebug("User Lang: " + USER_LANG);


/* ============================================================
   LISTA 43 JEZIKA KOJE TVOJA APLIKACIJA PODRŽAVA
============================================================ */
const SUPPORTED_LANGUAGES = [
    "sr","bs","hr","me", // ex-yu fallback
    "mk","sl","sq","bg","ro","hu",
    "en","de","fr","es","it","pt",
    "nl","pl","cs","sk","da","sv","fi","no","is",
    "et","lv","lt","uk","ru","tr","el",
    "ar","fa","hi","bn",
    "zh","ja","ko","vi","id","ms","th"
];

logDebug("Supported languages: " + SUPPORTED_LANGUAGES.length);


/* ============================================================
   SRODNI JEZICI — primarno za srpski cluster
============================================================ */
const RELATED_LANG = {
    "sr": ["bs","hr","me"],
    "bs": ["sr","hr","me"],
    "hr": ["sr","bs","me"],
    "me": ["sr","bs","hr"],

    "sk": ["cs"],
    "cs": ["sk"]
};


/* ============================================================
   FUNKCIJA: AUTOMATSKI IZBOR TITLOVA
   1) Sistem
   2) Srodni jezici
   3) Engleski auto-translate
   4) Ako nema → null
============================================================ */
function selectSubtitleTrack(availableSubs, sysLang) {
    if (!availableSubs || availableSubs.length === 0) {
        logDebug("No available subtitles array!");
        return null;
    }

    logDebug("Available YouTube subtitles: " + availableSubs.join(", "));

    // 1. Sistem
    if (availableSubs.includes(sysLang)) {
        logDebug("Using SYSTEM subtitle: " + sysLang);
        return sysLang;
    }

    // 2. Srodni jezici
    if (RELATED_LANG[sysLang]) {
        for (let rel of RELATED_LANG[sysLang]) {
            if (availableSubs.includes(rel)) {
                logDebug("Using RELATED subtitle: " + rel);
                return rel;
            }
        }
    }

    // 3. Ako engleski postoji → auto-translate
    if (availableSubs.includes("en")) {
        logDebug("EN exists → using English for auto-translate");
        return "auto-en";
    }

    // 4. Ako NIŠTA nema
    logDebug("NO suitable subtitles found.");
    return null;
}


/* ============================================================
   YouTube API READY
============================================================ */
let player = null;
let chosenSubtitle = null;
let hasStarted = false;

function onYouTubeIframeAPIReady() {
    if (!VIDEO_ID) {
        showToast("Video ID nije prosleđen.");
        return;
    }

    logDebug("Creating YT.Player...");

    player = new YT.Player("player", {
        height: "100%",
        width: "100%",
        videoId: VIDEO_ID,
        playerVars: {
            autoplay: 1,
            playsinline: 1,
            controls: 1,
            rel: 0,
            fs: 1,
            iv_load_policy: 3,
            enablejsapi: 1,
            cc_load_policy: 1,
            hl: SYSTEM_LANG
        },
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
        }
    });
}


/* ============================================================
   when READY → tražimo dostupne titlove
============================================================ */
function onPlayerReady() {
    logDebug("YT Player Ready");

    try {
        let tracks = player.getOption("captions", "tracklist") || [];
        let availableSubs = tracks.map(t => t.languageCode);

        chosenSubtitle = selectSubtitleTrack(availableSubs, USER_LANG);

        if (chosenSubtitle === null) {
            showToast("Titlovi nisu dostupni");
        } else if (chosenSubtitle.startsWith("auto-en")) {
            // auto-translate iz engleskog
            setTimeout(() => {
                player.setOption("captions", "track", { languageCode: "en" });
                player.setOption("captions", "translate", USER_LANG);
            }, 500);
        } else {
            // standardni titl
            setTimeout(() => {
                player.setOption("captions", "track", { languageCode: chosenSubtitle });
            }, 500);
        }

    } catch (err) {
        logDebug("Caption setup error: " + err);
    }

    hideLoading();
}
/* ============================================================
   STATE MACHINE — stabilno upravljanje reklamama i videom
============================================================ */
let isAdPlaying = false;
let adStartTime = 0;
let adTimeout = null;

/*  YouTube states:
    -1 UNSTARTED
     0 ENDED
     1 PLAYING
     2 PAUSED
     3 BUFFERING
     5 VIDEO CUED
   +108 AD START
   +109 AD END
*/

function onPlayerStateChange(event) {
    const state = event.data;
    logDebug("YT State: " + state);

    switch (state) {

        /* -----------------------------------------
           108 — Reklama počinje
        ----------------------------------------- */
        case 108:
            isAdPlaying = true;
            adStartTime = Date.now();
            logDebug("AD START detected (108)");
            break;

        /* -----------------------------------------
           109 — Reklama završena
        ----------------------------------------- */
        case 109:
            isAdPlaying = false;
            logDebug("AD ENDED (109)");
            break;

        /* -----------------------------------------
           1 — VIDEO PLAYING
        ----------------------------------------- */
        case YT.PlayerState.PLAYING:

            if (!hasStarted && !isAdPlaying) {
                hasStarted = true;
                hideLoading();
                showToast("Reprodukcija pokrenuta");
            }

            break;

        /* -----------------------------------------
           3 — BUFFERING (posebna kontrola reklama)
        ----------------------------------------- */
        case YT.PlayerState.BUFFERING:
            // Ako buffer traje predugo → YouTube reklama failed → FORCE PLAY video
            if (isAdPlaying) {
                const elapsed = Date.now() - adStartTime;

                if (elapsed > 6000) {  // max 6 sekundi reklama
                    logDebug("Ad buffering timeout → forcing video start");
                    isAdPlaying = false;
                    safeForcePlay();
                }
            }
            break;

        /* -----------------------------------------
           0 — ENDED
        ----------------------------------------- */
        case YT.PlayerState.ENDED:
            showToast("Video završio");
            break;
    }
}


/* ============================================================
   FORCE PLAY — otklanja petlju reklama
============================================================ */
function safeForcePlay() {
    try {
        player.pauseVideo();
        setTimeout(() => player.playVideo(), 300);
        logDebug("ForcePlay executed");
    } catch (e) {
        logDebug("ForcePlay error: " + e);
    }
}


/* ============================================================
   ERROR HANDLER
============================================================ */
function onPlayerError(err) {
    logDebug("PLAYER ERROR: " + JSON.stringify(err));
    showToast("Greška pri pokretanju videa");
}


/* ============================================================
   UI — LOADING
============================================================ */
function hideLoading() {
    const el = document.getElementById("loadingScreen");
    if (el) el.style.display = "none";
}


/* ============================================================
   TOAST MESSAGE
============================================================ */
let toastTimeout = null;

function showToast(text) {
    const box = document.getElementById("toastBox");
    if (!box) return;

    box.innerText = text;
    box.style.opacity = 1;

    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
        box.style.opacity = 0;
    }, 3000);
}


/* ============================================================
   DEBUG PANEL
============================================================ */
function logDebug(msg) {
    if (!DEBUG_ENABLED) return;
    const panel = document.getElementById("debugPanel");
    panel.style.display = "block";
    panel.innerHTML += msg + "<br>";
}
/* ============================================================
   AUTO-START PLAYER LOGIC
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
    logDebug("DOM loaded, waiting for YouTube API...");
});

</script>

</body>
</html>
