<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

        #loadingText {
            margin-top: 20px;
            font-size: 18px;
        }

        #playerContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        #toastBox {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20,20,20,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 200000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        #debugPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            color: #0f0;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 60%;
            max-height: 30%;
            overflow-y: auto;
            display: none;
            z-index: 200000;
        }

        /* SUBTITLE MENU POPUP */
        #subtitleMenu {
            position: absolute;
            top: 100px;
            right: 100px;
            width: 350px;
            max-height: 65%;
            overflow-y: auto;
            background: rgba(0,0,0,0.85);
            border: 2px solid #fff;
            border-radius: 12px;
            display: none;
            padding: 15px;
            color: #fff;
            z-index: 200000;
        }

        .menuTitle {
            font-size: 20px;
            margin-bottom: 12px;
            font-weight: bold;
        }

        .menuItem {
            padding: 10px;
            margin: 4px 0;
            background: #222;
            border-radius: 6px;
            cursor: pointer;
        }

        .menuItem:hover {
            background: #444;
        }
    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<div id="playerContainer">
    <div id="player"></div>
</div>

<div id="subtitleMenu"></div>

<div id="debugPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   PARAMETERS FROM ANDROID
============================================================ */
const params = new URLSearchParams(window.location.search);

const VIDEO_ID    = params.get("videoId") || null;
const USER_LANG   = params.get("lang") || "en";
const DEBUG_MODE  = params.get("debug") === "1";

log("VIDEO = " + VIDEO_ID);
log("USER_LANG = " + USER_LANG);

/* ============================================================
   43 SUPPORTED LANGUAGES (MUST MATCH ANDROID)
============================================================ */
const SUPPORTED = [
    "sr","bs","hr","me",
    "mk","sl","sq","bg","ro","hu",
    "en","de","fr","es","it","pt",
    "nl","pl","cs","sk","da","sv","fi","no","is",
    "et","lv","lt","uk","ru","tr","el",
    "ar","fa","hi","bn",
    "zh","ja","ko","vi","id","ms","th"
];

/* ============================================================
   EXTENDED RELATED LANGUAGE GROUPS
============================================================ */
const RELATED = {
    /* Ex-YU */
    "sr": ["bs","hr","me"],
    "bs": ["sr","hr","me"],
    "hr": ["sr","bs","me"],
    "me": ["sr","bs","hr"],

    /* Central Slavic */
    "sk": ["cs"],
    "cs": ["sk"],
    "sl": ["hr","sr"],
    "pl": ["cs","sk"],

    /* Scandinavian */
    "da": ["sv","no"],
    "sv": ["da","no","is"],
    "no": ["sv","da"],
    "is": ["sv"],

    /* Balkan East */
    "mk": ["bg","sr"],
    "bg": ["mk","sr"],

    /* East Europe */
    "uk": ["ru"],
    "ru": ["uk"],

    /* Turkish */
    "tr": ["az"],

    /* Romance */
    "fr": ["es","it","pt"],
    "es": ["fr","pt","it"],
    "pt": ["es","fr","it"],
    "it": ["es","fr","pt"],

    /* East Asian */
    "zh": ["ja","ko"],
    "ja": ["zh","ko"],
    "ko": ["zh","ja"]
};

/* ============================================================
   SUBTITLE SELECTION LOGIC
============================================================ */
function pickSubtitle(available, lang) {
    log("Available subs: " + available.join(", "));

    // 1) direct match
    if (available.includes(lang)) return lang;

    // 2) related languages
    if (RELATED[lang]) {
        for (let r of RELATED[lang]) {
            if (available.includes(r)) return r;
        }
    }

    // 3) auto-translate base (English)
    if (available.includes("en")) return "auto-en";

    // 4) none
    return null;
}

/* ============================================================
   YOUTUBE API READY
============================================================ */
let player = null;
let tracks = [];
let chosen = null;

function onYouTubeIframeAPIReady() {
    if (!VIDEO_ID) {
        toast("Nedostaje video ID");
        return;
    }

    player = new YT.Player("player", {
        width: "100%",
        height: "100%",
        videoId: VIDEO_ID,
        playerVars: {
            autoplay: 1,
            controls: 1,
            fs: 1,
            cc_load_policy: 1,
            enablejsapi: 1,
            iv_load_policy: 3,
            rel: 0,
            hl: USER_LANG
        },
        events: {
            onReady: onReady,
            onError: onError
        }
    });
}

/* ============================================================
   PLAYER READY → detect subtitles
============================================================ */
function onReady() {
    setTimeout(() => {
        try {
            tracks = player.getOption("captions", "tracklist") || [];
        } catch(e) { log("Tracklist error: " + e); }

        let langs = tracks.map(t => t.languageCode);
        chosen = pickSubtitle(langs, USER_LANG);

        if (!chosen) {
            toast("Nema titlova");
        } else if (chosen === "auto-en") {
            player.setOption("captions", "track", { languageCode: "en" });
            player.setOption("captions", "translate", USER_LANG);
        } else {
            player.setOption("captions", "track", { languageCode: chosen });
        }

        hideLoading();
    }, 800);
}

/* ============================================================
   SUBTITLE MENU (ArrowUp)
============================================================ */
function openSubtitleMenu() {
    const menu = document.getElementById("subtitleMenu");
    menu.innerHTML = "";

    const langs = tracks.map(t => t.languageCode);

    let html = `<div class="menuTitle">Titlovi</div>`;

    // Direct tracks
    langs.forEach(l => {
        html += `<div class="menuItem" onclick="setSub('${l}')">${l}</div>`;
    });

    // Auto translate options
    html += `<div class="menuTitle" style="margin-top:10px;">Auto Translate</div>`;
    SUPPORTED.forEach(l => {
        html += `<div class="menuItem" onclick="autoTranslate('${l}')">auto → ${l}</div>`;
    });

    // Off
    html += `<div class="menuItem" onclick="subOff()">Isključi titlove</div>`;

    menu.innerHTML = html;
    menu.style.display = "block";
}

function setSub(lang) {
    player.setOption("captions", "track", { languageCode: lang });
    toast("Titl: " + lang);
    closeMenu();
}

function autoTranslate(lang) {
    player.setOption("captions", "track", { languageCode: "en" });
    player.setOption("captions", "translate", lang);
    toast("Auto prevod → " + lang);
    closeMenu();
}

function subOff() {
    player.setOption("captions", "track", {});
    toast("Titlovi isključeni");
    closeMenu();
}

function closeMenu() {
    document.getElementById("subtitleMenu").style.display = "none";
}

/* ============================================================
   DPAD REMOTE CONTROL
============================================================ */
document.addEventListener("keydown", (e) => {

    switch(e.key) {

        case "ArrowLeft":
            try { player.seekTo(Math.max(0, player.getCurrentTime() - 20), true);}catch(e){}
            e.preventDefault();
            break;

        case "ArrowRight":
            try { player.seekTo(player.getCurrentTime() + 20, true);}catch(e){}
            e.preventDefault();
            break;

        case "Enter":
            try {
                let s = player.getPlayerState();
                if (s === 1) player.pauseVideo();
                else player.playVideo();
            } catch(e){}
            e.preventDefault();
            break;

        case "ArrowUp":
            openSubtitleMenu();
            e.preventDefault();
            break;

        case "ArrowDown":
            try {
                player.getIframe().contentWindow.postMessage(
                    JSON.stringify({event:"command",func:"showControls",args:[true]}),"*"
                );
            }catch(e){}
            e.preventDefault();
            break;
    }
});

/* ============================================================
   UTILITY FUNCTIONS
============================================================ */
function hideLoading(){
    document.getElementById("loadingScreen").style.display = "none";
}

let toastTimer = null;
function toast(msg){
    const box = document.getElementById("toastBox");
    box.innerHTML = msg;
    box.style.opacity = 1;

    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ box.style.opacity = 0; }, 3000);
}

function log(m){
    if (!DEBUG_MODE) return;
    const p = document.getElementById("debugPanel");
    p.style.display = "block";
    p.innerHTML += m + "<br>";
}

</script>

</body>
</html>
