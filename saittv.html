<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #loadingScreen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: white;
        }

        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }

        #loadingText { margin-top: 20px; font-size: 18px; }

        #playerContainer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        #player { width: 100%; height: 100%; }

        #debugPanel {
            position: absolute;
            bottom: 20px; left: 20px;
            padding: 12px 18px;
            background: rgba(0,0,0,0.6);
            color: #0f0;
            font-size: 14px;
            border-radius: 8px;
            display: none;
            z-index: 100000;
            max-width: 60%;
            max-height: 30%;
            overflow-y: auto;
        }

        #toastBox {
            position: absolute;
            top: 40px; left: 50%;
            transform: translateX(-50%);
            padding: 14px 26px;
            background: rgba(20,20,20,0.9);
            color: white;
            font-size: 18px;
            border-radius: 10px;
            z-index: 100000;
            opacity: 0;
            transition: opacity .4s ease;
        }
    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<div id="playerContainer"><div id="player"></div></div>

<div id="debugPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/*============================================================
  URL parametri (Android WebView)
============================================================*/
const urlParams = new URLSearchParams(window.location.search);

const VIDEO_ID     = urlParams.get("videoId") || null;
const SYSTEM_LANG  = urlParams.get("sys") || "en";
const USER_LANG    = urlParams.get("lang") || SYSTEM_LANG;
const DEBUG_ENABLED = urlParams.get("debug") === "1";

logDebug("VIDEO = " + VIDEO_ID);
logDebug("SYSTEM_LANG = " + SYSTEM_LANG);
logDebug("USER_LANG = " + USER_LANG);

/*============================================================
  43 jezika (ne briši ovo)
============================================================*/
const SUPPORTED_LANGUAGES = [
    "sr","bs","hr","me",
    "mk","sl","sq","bg","ro","hu",
    "en","de","fr","es","it","pt",
    "nl","pl","cs","sk","da","sv","fi","no","is",
    "et","lv","lt","uk","ru","tr","el",
    "ar","fa","hi","bn",
    "zh","ja","ko","vi","id","ms","th"
];

/*============================================================
  SRODNI JEZICI (ne briši)
============================================================*/
const RELATED_LANG = {
    "sr": ["bs","hr","me"],
    "bs": ["sr","hr","me"],
    "hr": ["sr","bs","me"],
    "me": ["sr","bs","hr"],
    "sk": ["cs"],
    "cs": ["sk"]
};

/*============================================================
  IZBOR TITLA (ostaje ista logika)
============================================================*/
function selectSubtitleTrack(availableSubs, lang) {

    logDebug("Available subs: " + availableSubs.join(", "));

    if (availableSubs.includes(lang)) return lang;

    if (RELATED_LANG[lang]) {
        for (let r of RELATED_LANG[lang]) {
            if (availableSubs.includes(r)) return r;
        }
    }

    if (availableSubs.includes("en")) return "auto-en";

    return null; // bez poruke
}

/*============================================================
   PLAYER INIT
============================================================*/
let player = null;
let chosenSubtitle = null;

function onYouTubeIframeAPIReady() {

    if (!VIDEO_ID) return;

    player = new YT.Player("player", {
        width: "100%", height: "100%",
        videoId: VIDEO_ID,
        playerVars: {
            autoplay: 1,
            controls: 1,
            rel: 0,
            fs: 1,
            iv_load_policy: 3,
            enablejsapi: 1,
            cc_load_policy: 1,
            hl: USER_LANG
        },
        events: {
            onReady: onReady,
            onStateChange: (e)=>{ if(e.data===YT.PlayerState.PLAYING) hideLoading(); }
        }
    });
}

function onReady() {

    let tracks = [];
    try { tracks = player.getOption("captions","tracklist") || []; } catch(e){}

    const availableSubs = tracks.map(t => t.languageCode);
    chosenSubtitle = selectSubtitleTrack(availableSubs, USER_LANG);

    if (chosenSubtitle === "auto-en") {
        setTimeout(()=>{
            player.setOption("captions","track",{languageCode:"en"});
            player.setOption("captions","translate",USER_LANG);
        },300);
    }
    else if (chosenSubtitle) {
        setTimeout(()=>{
            player.setOption("captions","track",{languageCode:chosenSubtitle});
        },300);
    }

    hideLoading();
}

/*============================================================
  REMOTE CONTROL FINAL
============================================================*/
document.addEventListener("keydown", (e)=>{

    switch(e.key){

        case "ArrowLeft":
            try { player.seekTo(Math.max(0,player.getCurrentTime()-20),true); } catch{}
            e.preventDefault();
        break;

        case "ArrowRight":
            try { player.seekTo(player.getCurrentTime()+20,true); } catch{}
            e.preventDefault();
        break;

        case "Enter":
        case "OK":
            try {
                const s = player.getPlayerState();
                if (s === 1) player.pauseVideo();
                else player.playVideo();
            } catch{}
            e.preventDefault();
        break;

        case "ArrowDown":
            try {
                player.getIframe().contentWindow.postMessage(
                    JSON.stringify({
                        event:"command",
                        func:"showControls",
                        args:[true]
                    }),
                "*");
            } catch{}
            e.preventDefault();
        break;

        /*======================================================
           ARROW UP = OTVORI YOUTUBE SETTINGS (ZUPČANIK)
           * radi preko real key dispatch u iframe *
        ======================================================*/
        case "ArrowUp":
            try {
                const iframe = player.getIframe().contentWindow;

                iframe.postMessage(JSON.stringify({
                    event:"command",
                    func:"dispatchEvent",
                    args:[{
                        type:"keydown",
                        key:"ArrowUp",
                        code:"ArrowUp",
                        keyCode:38,
                        which:38,
                        bubbles:true
                    }]
                }),"*");

                iframe.postMessage(JSON.stringify({
                    event:"command",
                    func:"dispatchEvent",
                    args:[{
                        type:"keyup",
                        key:"ArrowUp",
                        code:"ArrowUp",
                        keyCode:38,
                        which:38,
                        bubbles:true
                    }]
                }),"*");

            } catch(err){
                logDebug("UP error: "+err);
            }
            e.preventDefault();
        break;
    }
});

/*============================================================
  UI HELPERS
============================================================*/
function hideLoading(){
    const el=document.getElementById("loadingScreen");
    if(el) el.style.display="none";
}

function logDebug(msg){
    if(!DEBUG_ENABLED) return;
    const p=document.getElementById("debugPanel");
    p.style.display="block";
    p.innerHTML+=msg+"<br>";
}

</script>

</body>
</html>
