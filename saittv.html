<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouFlix TV Player</title>

<style>
    body, html {
        margin: 0;
        padding: 0;
        background: #000;
        overflow: hidden;
        width: 100%;
        height: 100%;
        font-family: Arial;
    }

    #loadingScreen {
        position: absolute; top:0; left:0;
        width:100%; height:100%;
        background:#000;
        display:flex; flex-direction:column;
        justify-content:center; align-items:center;
        z-index:99999; color:white;
    }

    #player { width:100%; height:100%; }

    #subtitleMenu {
        position:absolute;
        top:120px;
        right:100px;
        width:380px;
        max-height:65%;
        overflow-y:auto;
        background:rgba(0,0,0,0.85);
        border:2px solid white;
        border-radius:12px;
        padding:15px;
        color:white;
        display:none;
        z-index:999999;
    }

    .menuTitle {
        font-size:22px;
        margin-bottom:10px;
        font-weight:bold;
    }

    .menuItem {
        padding:12px;
        margin:5px 0;
        background:#222;
        border-radius:6px;
        cursor:pointer;
    }

    .menuItem:focus {
        outline:2px solid red;
        background:#444;
    }
</style>
</head>

<body>

<div id="loadingScreen">
    <div style="color:#fff;font-size:20px;">Učitavam player...</div>
</div>

<div id="player"></div>
<div id="subtitleMenu"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   PARAMETRI IZ ANDROID-A
============================================================ */
const params = new URLSearchParams(window.location.search);
const VIDEO_ID = params.get("videoId");
const USER_LANG = params.get("lang") || "en";

/* ============================================================
   RELATED jezici kao pre
============================================================ */
const RELATED = {
    "sr":["bs","hr"],
    "bs":["sr","hr"],
    "hr":["sr","bs"],
    "sk":["cs"],
    "cs":["sk"],
    "sl":["hr","sr"],
    "pl":["cs","sk"],
    "da":["sv","no"],
    "sv":["da","no"],
    "no":["sv","da"],
    "mk":["bg","sr"],
    "bg":["mk","sr"],
    "uk":["ru"],
    "ru":["uk"],
    "fr":["es","it","pt"],
    "es":["fr","pt","it"],
    "pt":["es","fr","it"],
    "it":["es","fr","pt"],
    "zh":["ja","ko"],
    "ja":["zh","ko"],
    "ko":["zh","ja"]
};

/* ============================================================
   GLOBAL VARS
============================================================ */
let player = null;
let tracks = [];
let chosen = null;

/* ============================================================
   YT API load
============================================================ */
function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        height:"100%", width:"100%",
        videoId: VIDEO_ID,
        playerVars:{
            autoplay:1,
            controls:1,
            fs:1,
            cc_load_policy:1,
            enablejsapi:1,
            iv_load_policy:3,
            rel:0,
            hl:USER_LANG
        },
        events:{
            onReady:onReady
        }
    });
}

/* ============================================================
   Auto pick SUBTITLE — STARA VERZIJA KOJA TI JE RADILA
============================================================ */
function pickSubtitle(available, lang) {

    // 1) direct
    if (available.includes(lang)) return lang;

    // 2) related group
    if (RELATED[lang]) {
        for (let r of RELATED[lang]) {
            if (available.includes(r)) return r;
        }
    }

    // 3) auto translate base
    if (available.includes("en")) return "auto-en";

    return null;
}

/* ============================================================
   PLAYER READY
============================================================ */
function onReady() {

    setTimeout(() => {

        try {
            tracks = player.getOption("captions","tracklist") || [];
        } catch(e){}

        const langs = tracks.map(t=>t.languageCode);
        chosen = pickSubtitle(langs, USER_LANG);

        /* AUTO APPLY SUBTITLE */
        if (!chosen) {
            // nema titlova → auto translate sa engleskog
            player.setOption("captions","track",{languageCode:"en"});
            setTimeout(()=>{
                player.setOption("captions","translate", USER_LANG);
            }, 350);

        } else if (chosen === "auto-en") {
            // auto
            player.setOption("captions","track",{languageCode:"en"});
            setTimeout(()=>{
                player.setOption("captions","translate", USER_LANG);
            }, 350);

        } else {
            // direct match
            player.setOption("captions","track",{languageCode:chosen});
        }

        document.getElementById("loadingScreen").style.display="none";

    }, 1000);
}

/* ============================================================
   SUBTITLE MENU (UP)
============================================================ */
function openSubtitleMenu() {
    const menu = document.getElementById("subtitleMenu");
    menu.innerHTML = "";

    let html = `<div class="menuTitle">Titlovi</div>`;

    // existing YT subtitles FIRST
    tracks.forEach(t => {
        html += `<div class="menuItem" tabindex="0" onclick="setSub('${t.languageCode}')">${t.languageCode}</div>`;
    });

    // auto translate section
    html += `<div class="menuTitle" style="margin-top:12px;">Auto Translate</div>`;
    SUPPORTED.forEach(l=>{
        html += `<div class="menuItem" tabindex="0" onclick="autoTranslate('${l}')">auto → ${l}</div>`;
    });

    html += `<div class="menuItem" tabindex="0" onclick="subOff()">Isključi titlove</div>`;

    menu.innerHTML = html;
    menu.style.display = "block";

    // Set FOCUS on first item (TV navigation)
    const first = menu.querySelector(".menuItem");
    if (first) first.focus();
}

/* DIRECT SUBTITLE */
function setSub(l){
    player.setOption("captions","track",{languageCode:l});
    closeMenu();
}

/* AUTO TRANSLATE */
function autoTranslate(l){
    player.setOption("captions","track",{languageCode:"en"});
    setTimeout(()=>{
        player.setOption("captions","translate", l);
    },350);
    closeMenu();
}

function subOff(){
    player.setOption("captions","track",{});
    closeMenu();
}

function closeMenu(){
    document.getElementById("subtitleMenu").style.display="none";
}

/* ============================================================
   DPAD — IDENTIČAN STAROJ VERZIJI KOJA JE RADILA
============================================================ */
document.addEventListener("keydown", e => {

    switch(e.key){

        case "ArrowLeft":
            player.seekTo(player.getCurrentTime()-20, true);
            e.preventDefault();
            break;

        case "ArrowRight":
            player.seekTo(player.getCurrentTime()+20, true);
            e.preventDefault();
            break;

        case "Enter":
            if (player.getPlayerState()===1) player.pauseVideo();
            else player.playVideo();
            e.preventDefault();
            break;

        case "ArrowUp":
            openSubtitleMenu();
            e.preventDefault();
            break;

        case "ArrowDown":
            // samo YouTube kontrole (kao pre)
            try {
                player.getIframe().contentWindow.postMessage(
                    JSON.stringify({event:"command",func:"showControls",args:[true]}),
                    "*"
                );
            } catch(err){}
            e.preventDefault();
            break;
    }
});
</script>

</body>
</html>
