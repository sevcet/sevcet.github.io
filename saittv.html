<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        /* Loading Screen */
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            margin-top: 20px;
            font-size: 18px;
        }

        #playerContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        #debugPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            color: #0f0;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 60%;
            max-height: 30%;
            overflow-y: auto;
            display: none;
            z-index: 100000;
        }

        #toastBox {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20,20,20,0.9);
            color: white;
            padding: 14px 26px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 100000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<div id="playerContainer">
    <div id="player"></div>
</div>

<div id="debugPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   ANDROID PARAMS
============================================================ */
const urlParams = new URLSearchParams(window.location.search);
const VIDEO_ID = urlParams.get("videoId") || null;
const SYSTEM_LANG = urlParams.get("sys") || "en";
const USER_LANG = urlParams.get("lang") || SYSTEM_LANG;
const DEBUG_ENABLED = urlParams.get("debug") === "1";

logDebug("VIDEO_ID = " + VIDEO_ID);
logDebug("SYSTEM_LANG = " + SYSTEM_LANG);
logDebug("USER_LANG = " + USER_LANG);

/* ============================================================
   SUPPORTED LANGUAGES
============================================================ */
const SUPPORTED_LANGUAGES = [
    "sr","bs","hr","me",
    "mk","sl","sq","bg","ro","hu",
    "en","de","fr","es","it","pt",
    "nl","pl","cs","sk","da","sv","fi","no","is",
    "et","lv","lt","uk","ru","tr","el",
    "ar","fa","hi","bn",
    "zh","ja","ko","vi","id","ms","th"
];

/* ============================================================
   RELATED LANG GROUP
============================================================ */
const RELATED_LANG = {
    "sr": ["bs","hr","me"],
    "bs": ["sr","hr","me"],
    "hr": ["sr","bs","me"],
    "me": ["sr","bs","hr"],
    "sk": ["cs"],
    "cs": ["sk"]
};

/* ============================================================
   SUBTITLE SELECTION LOGIC
============================================================ */
function selectSubtitleTrack(availableSubs, lang) {
    if (!availableSubs || availableSubs.length === 0) return null;

    // 1) USER CHOICE
    if (availableSubs.includes(lang)) return lang;

    // 2) SYSTEM LANG
    if (availableSubs.includes(SYSTEM_LANG)) return SYSTEM_LANG;

    // 3) RELATED LANG
    if (RELATED_LANG[lang]) {
        for (let r of RELATED_LANG[lang])
            if (availableSubs.includes(r)) return r;
    }

    // 4) AUTO-TRANSLATE FROM EN
    if (availableSubs.includes("en")) return "auto-en";

    return null;
}

/* ============================================================
   YOUTUBE PLAYER
============================================================ */
let player = null;
let chosenSubtitle = null;

function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        width: "100%",
        height: "100%",
        videoId: VIDEO_ID,
        playerVars: {
            autoplay: 1,
            controls: 1,
            fs: 1,
            rel: 0,
            cc_load_policy: 1,
            playsinline: 1,
            enablejsapi: 1,
            iv_load_policy: 3,
            modestbranding: 1
        },
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
        }
    });
}

/* ============================================================
   PLAYER READY
============================================================ */
function onPlayerReady() {
    hideLoading();

    setTimeout(() => {
        try {
            let tracks = player.getOption("captions", "tracklist") || [];
            let availableSubs = tracks.map(t => t.languageCode);

            chosenSubtitle = selectSubtitleTrack(availableSubs, USER_LANG);

            // NORMAL SUBTITLE
            if (chosenSubtitle && !chosenSubtitle.startsWith("auto-")) {
                player.setOption("captions", "track", { languageCode: chosenSubtitle });
            }

            // AUTO TRANSLATE
            if (chosenSubtitle && chosenSubtitle.startsWith("auto-")) {
                player.setOption("captions", "track", { languageCode: "en" });
                player.setOption("captions", "translate", USER_LANG);
            }

        } catch (e) {
            logDebug("Subtitle error: " + e);
        }
    }, 800);
}

/* ============================================================
   STATE MACHINE
============================================================ */
function onPlayerStateChange(e) {
    if (e.data === YT.PlayerState.PLAYING) hideLoading();
}

/* ============================================================
   ERRORS
============================================================ */
function onPlayerError() {
    showToast("Greška pri pokretanju videa");
}

/* ============================================================
   UI HELPERS
============================================================ */
function hideLoading() {
    document.getElementById("loadingScreen").style.display = "none";
}

let toastTimeout = null;
function showToast(t) {
    const b = document.getElementById("toastBox");
    b.innerText = t;
    b.style.opacity = 1;

    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => b.style.opacity = 0, 3000);
}

function logDebug(msg) {
    if (!DEBUG_ENABLED) return;
    const p = document.getElementById("debugPanel");
    p.style.display = "block";
    p.innerHTML += msg + "<br>";
}

/* ============================================================
   REMOTE CONTROL
============================================================ */
let longPressTimeout = null;
let longPressActive = false;

document.addEventListener("keydown", (e) => {

    switch (e.key) {

        case "ArrowLeft":
            try {
                player.seekTo(Math.max(0, player.getCurrentTime() - 20), true);
            } catch {}
            e.preventDefault();
        break;

        case "ArrowRight":
            try {
                player.seekTo(player.getCurrentTime() + 20, true);
            } catch {}
            e.preventDefault();
        break;

        case "Enter":
        case "OK":
            try {
                const st = player.getPlayerState();
                if (st === 1) player.pauseVideo();
                else player.playVideo();
            } catch {}
            e.preventDefault();
        break;

        case "ArrowUp":

            // LONG PRESS = Stats for nerds
            if (longPressTimeout) clearTimeout(longPressTimeout);
            longPressActive = false;

            longPressTimeout = setTimeout(() => {
                longPressActive = true;
                openStatsForNerds();
            }, 650);

            // SHORT PRESS = YOUTUBE SETTINGS PANEL (SLIKA 2)
            setTimeout(() => {
                if (!longPressActive) {
                    openSettingsMenu();
                }
            }, 120);

            e.preventDefault();
        break;

        case "ArrowDown":
            // default YouTube controls
            player.playVideo();
        break;
    }
});

/* ============================================================
   OPEN SETTINGS MENU (SLIKA 2)
============================================================ */
function openSettingsMenu() {
    try {
        player.getIframe().contentWindow.postMessage(
            JSON.stringify({
                event: "command",
                func: "showControls",
                args: [true]
            }),
            "*"
        );

        player.getIframe().contentWindow.postMessage(
            JSON.stringify({
                event: "command",
                func: "openSettingsMenu",
                args: []
            }),
            "*"
        );

    } catch (e) {
        logDebug("openSettingsMenu error: " + e);
    }
}

/* ============================================================
   STATS FOR NERDS
============================================================ */
function openStatsForNerds() {
    try {
        showToast("Stats for nerds");
        player.getIframe().contentWindow.postMessage(
            JSON.stringify({
                event: "command",
                func: "toggleStatsForNerds",
                args: []
            }),
            "*"
        );
    } catch (e) {
        logDebug("stats error: " + e);
    }
}

</script>

</body>
</html>
