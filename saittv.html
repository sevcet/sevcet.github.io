<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            margin-top: 20px;
            font-size: 18px;
        }

        #playerContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        #debugPanel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            color: #0f0;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 60%;
            max-height: 30%;
            overflow-y: auto;
            display: none;
            z-index: 100000;
        }

        #toastBox {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20,20,20,0.9);
            color: white;
            padding: 14px 26px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 100000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<div id="playerContainer">
    <div id="player"></div>
</div>

<div id="debugPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   PARAMETRI IZ ANDROID APLIKACIJE
============================================================ */
const urlParams = new URLSearchParams(window.location.search);

const VIDEO_ID = urlParams.get("videoId") || null;
const USER_LANG = urlParams.get("lang") || "en";
const DEBUG_ENABLED = urlParams.get("debug") === "1";

logDebug("Loading video: " + VIDEO_ID);
logDebug("User selected language: " + USER_LANG);

/* ============================================================
   SRODNI JEZICI
============================================================ */
const RELATED_LANG = {
    "sr": ["hr","bs"],
    "hr": ["sr","bs"],
    "bs": ["sr","hr"],
    "sk": ["cs"],
    "cs": ["sk"]
};

/* ============================================================
   AUTOPRVI SUBTRACK
============================================================ */
function selectSubtitleTrack(availableSubs, lang) {

    if (availableSubs.includes(lang)) return lang;

    if (RELATED_LANG[lang]) {
        for (let r of RELATED_LANG[lang])
            if (availableSubs.includes(r)) return r;
    }

    if (availableSubs.includes("en")) return "auto-en";  // auto translate

    return null;
}

/* ============================================================
   YOUTUBE API
============================================================ */
let player = null;

function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        height: "100%",
        width: "100%",
        videoId: VIDEO_ID,
        playerVars: {
            autoplay: 1,
            playsinline: 1,
            controls: 1,
            rel: 0,
            fs: 1,
            iv_load_policy: 3,
            enablejsapi: 1,
            cc_load_policy: 1
        },
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange
        }
    });
}

function onPlayerReady() {
    hideLoading();

    setTimeout(() => {
        let tracks = player.getOption("captions", "tracklist") || [];
        let subs = tracks.map(t => t.languageCode);

        let chosen = selectSubtitleTrack(subs, USER_LANG);

        if (chosen === "auto-en") {
            player.setOption("captions", "track", { languageCode: "en" });
            player.setOption("captions", "translate", USER_LANG);
        } else if (chosen !== null) {
            player.setOption("captions", "track", { languageCode: chosen });
        }
    }, 400);
}

function onPlayerStateChange(e) {}

/* ============================================================
   LOADING
============================================================ */
function hideLoading() {
    document.getElementById("loadingScreen").style.display = "none";
}

/* ============================================================
   DEBUG PANEL
============================================================ */
function logDebug(msg) {
    if (!DEBUG_ENABLED) return;
    const p = document.getElementById("debugPanel");
    p.style.display = "block";
    p.innerHTML += msg + "<br>";
}

/* ============================================================
   REMOTE CONTROLLER ENGINE (TV KEYS)
============================================================ */
document.addEventListener("keydown", e => {

    if (!player) return;

    switch (e.key) {

        case "ArrowLeft":
            player.seekTo(Math.max(0, player.getCurrentTime() - 10), true);
            break;

        case "ArrowRight":
            player.seekTo(player.getCurrentTime() + 10, true);
            break;

        case "Enter":
        case "OK":
        case " ":
        case "Center":
        case "Select":
            // OTVARA YOUTUBE SETTINGS MENU (cc / quality / speed / subtitles)
            player.getIframe().contentWindow.postMessage(
                JSON.stringify({ event: "command", func: "showVideoInfo" }),
                "*"
            );
            break;

        case "ArrowUp":
            // YouTube internal controls (ostavi normalno ponašanje)
            break;

        case "ArrowDown":
            // Isto
            break;
    }
});
</script>

</body>
</html>
