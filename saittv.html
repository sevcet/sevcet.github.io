<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouFlix TV Player</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        /* Loading */
        #loadingScreen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: white;
        }

        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg);} }

        #playerContainer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; }
        #player { width:100%; height:100%; }

        #toastBox {
            position: absolute;
            top: 40px; left: 50%;
            transform: translateX(-50%);
            background: rgba(20,20,20,0.9);
            color: white;
            padding: 14px 26px;
            border-radius: 10px;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.4s;
            z-index: 100000;
        }

        /* Subtitle Menu */
        #subtitleMenu {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 420px;
            max-height: 65%;
            background: rgba(0,0,0,0.85);
            border-radius: 12px;
            padding: 20px;
            color: white;
            display: none;
            flex-direction: column;
            z-index: 100000;
        }

        #subtitleMenu h2 {
            margin: 0 0 10px 0;
            font-size: 22px;
            text-align: center;
        }

        #subtitleList {
            margin-top: 10px;
            overflow-y: auto;
            max-height: 70%;
        }

        .subItem {
            padding: 12px;
            margin-bottom: 6px;
            font-size: 18px;
            background: #222;
            border-radius: 8px;
        }

        .subItem.focused {
            background: #ff4444;
        }

        #debugPanel {
            position: absolute; bottom:20px; left:20px;
            background: rgba(0,0,0,0.6);
            color:#0f0;
            padding:12px 18px;
            border-radius:8px;
            font-size:14px;
            max-width:60%; max-height:30%;
            overflow-y:auto;
            display:none;
            z-index:100000;
        }
    </style>
</head>

<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Učitavam YouFlix player...</div>
</div>

<div id="toastBox"></div>

<div id="playerContainer"><div id="player"></div></div>

<div id="subtitleMenu">
    <h2>Subtitles</h2>
    <div id="subtitleList"></div>
</div>

<div id="debugPanel"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ============================================================
   PARAMS
============================================================ */
const urlParams = new URLSearchParams(window.location.search);
const VIDEO_ID = urlParams.get("videoId");
const USER_LANG = urlParams.get("lang") || "en";
const DEBUG = urlParams.get("debug") === "1";

log("HTML Loaded");
log("VIDEO = " + VIDEO_ID);
log("USER_LANG = " + USER_LANG);

/* ============================================================
   SUBTITLE GROUPS
============================================================ */
const RELATED = {
    "sr": ["bs","hr","me"],
    "bs": ["sr","hr","me"],
    "hr": ["sr","bs","me"],
    "me": ["sr","bs","hr"],
    "sk": ["cs"],
    "cs": ["sk"]
};

/* ============================================================
   PLAYER
============================================================ */
let player = null;
let availableSubs = [];
let currentIndex = 0;
let menuOpen = false;

function onYouTubeIframeAPIReady() {
    if (!VIDEO_ID) return;

    player = new YT.Player("player", {
        height: "100%", width: "100%",
        videoId: VIDEO_ID,
        playerVars: {
            autoplay: 1,
            controls: 1,
            fs: 1,
            rel: 0,
            enablejsapi: 1,
            cc_load_policy: 1,
            hl: USER_LANG
        },
        events: {
            onReady: onReady,
            onError: e => log("YT ERROR: " + JSON.stringify(e))
        }
    });
}

/* ============================================================
   ON READY
============================================================ */
function onReady() {
    hideLoading();

    setTimeout(() => {
        let tracks = [];

        try {
            tracks = player.getOption("captions", "tracklist") || [];
        } catch {}

        availableSubs = tracks.map(t => t.languageCode);

        if (availableSubs.length === 0) {
            showToast("No subtitles available");
        }

        loadInitialSubtitle();
        buildSubtitleMenuUI();

    }, 800);
}

/* ======================= SELECT INITIAL ====================== */
function loadInitialSubtitle() {
    if (availableSubs.includes(USER_LANG)) {
        setSubtitle(USER_LANG);
        return;
    }

    if (RELATED[USER_LANG]) {
        for (let r of RELATED[USER_LANG]) {
            if (availableSubs.includes(r)) {
                setSubtitle(r);
                return;
            }
        }
    }

    if (availableSubs.includes("en")) {
        setAutoTranslate(USER_LANG);
        return;
    }
}

/* ============================ MENU UI ========================= */
function buildSubtitleMenuUI() {
    const list = document.getElementById("subtitleList");
    list.innerHTML = "";

    availableSubs.forEach(lang => {
        const item = document.createElement("div");
        item.className = "subItem";
        item.innerText = lang;
        list.appendChild(item);
    });

    const auto = document.createElement("div");
    auto.className = "subItem";
    auto.innerText = "Auto-translate → " + USER_LANG;
    auto.dataset.auto = "1";
    list.appendChild(auto);

    const off = document.createElement("div");
    off.className = "subItem";
    off.innerText = "Turn off subtitles";
    off.dataset.off = "1";
    list.appendChild(off);
}

/* =========================== SHOW MENU ======================== */
function openMenu() {
    document.getElementById("subtitleMenu").style.display = "flex";
    menuOpen = true;
    focusItem(0);
}

/* =========================== CLOSE MENU ======================= */
function closeMenu() {
    document.getElementById("subtitleMenu").style.display = "none";
    menuOpen = false;
}

/* =========================== FOCUS HANDLING =================== */
function focusItem(i) {
    const items = document.querySelectorAll(".subItem");
    items.forEach(x => x.classList.remove("focused"));
    items[i].classList.add("focused");
    currentIndex = i;
}

/* ============================ APPLY SUB ======================= */
function applyCurrentItem() {
    const item = document.querySelectorAll(".subItem")[currentIndex];

    if (item.dataset.auto === "1") {
        setAutoTranslate(USER_LANG);
        showToast("Auto-translate → " + USER_LANG);
    }
    else if (item.dataset.off === "1") {
        disableSub();
        showToast("Subtitles off");
    }
    else {
        setSubtitle(item.innerText);
        showToast("Subtitle: " + item.innerText);
    }

    closeMenu();
}

/* ============================ SET SUB ========================= */
function setSubtitle(code) {
    try {
        player.setOption("captions", "track", { languageCode: code });
    } catch {}
}

function disableSub() {
    try {
        player.setOption("captions", "track", {});
    } catch {}
}

function setAutoTranslate(toLang) {
    try {
        player.setOption("captions", "track", { languageCode: "en" });
        player.setOption("captions", "translate", toLang);
    } catch {}
}

/* ============================================================
   REMOTE CONTROL (DPAD)
============================================================ */
document.addEventListener("keydown", e => {

    /* MENU MODE */
    if (menuOpen) {
        switch (e.key) {
            case "ArrowUp":
                focusItem(Math.max(0, currentIndex - 1));
                break;

            case "ArrowDown":
                const max = document.querySelectorAll(".subItem").length - 1;
                focusItem(Math.min(max, currentIndex + 1));
                break;

            case "Enter":
            case "OK":
                applyCurrentItem();
                break;

            case "Backspace":
            case "Escape":
                closeMenu();
                break;
        }
        e.preventDefault();
        return;
    }

    /* NORMAL MODE */
    switch (e.key) {

        /* Skip backward */
        case "ArrowLeft":
            try { player.seekTo(Math.max(0, player.getCurrentTime() - 20), true);} catch {}
            e.preventDefault();
            break;

        /* Skip forward */
        case "ArrowRight":
            try { player.seekTo(player.getCurrentTime() + 20, true);} catch {}
            e.preventDefault();
            break;

        /* OPEN SUBTITLE MENU */
        case "ArrowUp":
            openMenu();
            e.preventDefault();
            break;

        /* Show controls */
        case "ArrowDown":
            try {
                player.getIframe().contentWindow.postMessage(JSON.stringify({
                    event:"command",
                    func:"showControls",
                    args:[true]
                }), "*");
            } catch {}
            e.preventDefault();
            break;

        /* Play/Pause */
        case "Enter":
        case "OK":
            try {
                const st = player.getPlayerState();
                if (st === 1) player.pauseVideo();
                else player.playVideo();
            } catch {}
            e.preventDefault();
            break;
    }
});

/* ============================================================
   UI HELPERS
============================================================ */
function hideLoading() {
    const el = document.getElementById("loadingScreen");
    if (el) el.style.display = "none";
}

function showToast(t) {
    const box = document.getElementById("toastBox");
    box.innerText = t;
    box.style.opacity = 1;

    setTimeout(() => { box.style.opacity = 0; }, 3000);
}

function log(m) {
    if (!DEBUG) return;
    const p = document.getElementById("debugPanel");
    p.style.display = "block";
    p.innerHTML += m + "<br>";
}

</script>

</body>
</html>
